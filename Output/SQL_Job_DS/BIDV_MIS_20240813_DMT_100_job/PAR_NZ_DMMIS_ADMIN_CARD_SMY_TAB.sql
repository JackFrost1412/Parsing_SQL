SELECT 
		m.AR_DIM_ID									AR_DIM_ID, 
		c.CIF_NO									CIF_NO,
		m.SETL_AC_NBR								SETL_AC_NBR,
						case when m.AR_NO = 0 then cast(substr(m.unq_id_src_stm,0,30) as varchar(30)) else cast(m.ar_no as varchar(30)) end		CARD_NO,
		p.PD_CODE||' - '||m.PD_NM										CARD_PD_TP,
		e.TRGT_ST_NM								CARD_ST,
		e.TRGT_ST_CODE								CARD_ST_CODE,
		m.EFF_DT									ISSU_DT,
		m.MTH_ISSU_TP								MTH_ISSU_TP,
		m.EST_END_DT								EST_END_DT,
		NVL(smy_mtd.CASH_SALE_AMT_LCY_MTD, 0) 		CASH_SALE_AMT_LCY_MTD,
		NVL(smy_lmth.CASH_SALE_AMT_LCY_LMTH, 0)		CASH_SALE_AMT_LCY_LMTH,
		NVL(smy_lmth.INT_INCM_LCY_LMTH, 0)			INT_INCM_LCY_LMTH,
		:pDate:								TM_PRD_DIM_ID,
		ar_fct.CLS_BAL_AMT_TDY_LCY					CLS_BAL_AMT_TDY_LCY
FROM AR_DIM m
LEFT JOIN PD_DIM p ON p.PD_ID = m.PD_ID AND to_char(p.EFF_TO_DT, 'YYYYDDD') = 2099365 
LEFT JOIN CST_DIM c ON c.CST_ID = m.CST_ID AND to_char(c.EFF_TO_DT, 'YYYYDDD') = 2099365
LEFT JOIN AR_DIM a ON a.AR_NO = m.PRIM_AR_NO AND to_char(a.EFF_TO_DT, 'YYYYDDD') = 2099365 AND a.SRC_STM = 'CADENCIE_ACCT'
LEFT JOIN EX_MAP_CARD_ST_VW_CST e ON e.SRC_ST_CODE = m.SRC_ST_CODE AND e.SRC_STM_CODE = m.SRC_STM 
				AND :pDate: >= to_char(e.EFF_FM_DT, 'YYYYDDD')
		AND :pDate: < to_char(e.EFF_TO_DT, 'YYYYDDD')
LEFT JOIN AST_AR_ANL_FCT_DAY_LCY_1_DAILY ar_fct ON ar_fct.AR_DIM_ID = a.AR_DIM_ID AND :pDate: = TM_PRD_DIM_ID
LEFT JOIN 
(
	SELECT PRIM_AR_DIM_ID, SUM(TXN_DB_AMT_LCY - TXN_CR_AMT_LCY) CASH_SALE_AMT_LCY_MTD FROM CNL_TXN_ANL_FCT t
	INNER JOIN SRC_STM_DIM s ON s.SRC_STM_DIM_ID = t.SRC_STM_DIM_ID AND s.LVL_0_CODE in ('CADENCIE_EVENT', 'OASIS_SHCLOG')
	INNER JOIN TXN_CODE_DIM t1 ON t1.TXN_CODE_DIM_ID = t.TXN_CODE_DIM_ID AND TXN_GRP_NM in ('Cash Withdrawal', 'Sale')
	WHERE t.TXN_AMT_IND = 'Y'
		AND to_char(DATE_TRUNC('MONTH', to_date(:pDate:, 'YYYYDDD')), 'YYYYDDD') <= CDR_DIM_ID
		AND CDR_DIM_ID <= :pDate:
	GROUP BY PRIM_AR_DIM_ID
) smy_mtd ON smy_mtd.PRIM_AR_DIM_ID = m.AR_DIM_ID
LEFT JOIN 
(
	SELECT PRIM_AR_DIM_ID, SUM(CASE WHEN t1.TXN_GRP_NM in ('Cash Withdrawal', 'Sale') THEN TXN_DB_AMT_LCY - TXN_CR_AMT_LCY ELSE 0 END) CASH_SALE_AMT_LCY_LMTH, 
							SUM(CASE WHEN t1.LVL_0_CODE = '5000' THEN TXN_CR_AMT_LCY - TXN_DB_AMT_LCY ELSE 0 END)  INT_INCM_LCY_LMTH 
	FROM CNL_TXN_ANL_FCT t
	INNER JOIN SRC_STM_DIM s ON s.SRC_STM_DIM_ID = t.SRC_STM_DIM_ID AND s.LVL_0_CODE in ('CADENCIE_EVENT', 'OASIS_SHCLOG')
	INNER JOIN TXN_CODE_DIM t1 ON t1.TXN_CODE_DIM_ID = t.TXN_CODE_DIM_ID AND (t1.TXN_GRP_NM in ('Cash Withdrawal', 'Sale') OR t1.LVL_0_CODE = '5000')
	WHERE t.TXN_AMT_IND = 'Y'
		AND to_char(DATE_TRUNC('MONTH', DATE_TRUNC('MONTH', to_date(:pDate:, 'YYYYDDD'))-1), 'YYYYDDD') <= CDR_DIM_ID 
		AND CDR_DIM_ID <= to_char(DATE_TRUNC('MONTH', to_date(:pDate:, 'YYYYDDD'))-1, 'YYYYDDD')
	GROUP BY PRIM_AR_DIM_ID
		
) smy_lmth ON smy_lmth.PRIM_AR_DIM_ID = m.AR_DIM_ID
WHERE m.SRC_STM in ('CADENCIE_CARD', 'DATATM_X1PCMS');

