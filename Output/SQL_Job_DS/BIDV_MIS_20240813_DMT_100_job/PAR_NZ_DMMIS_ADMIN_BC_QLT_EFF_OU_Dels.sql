SELECT
AR_FCT.ORG_UNIT_DIM_ID, 
AR_FCT.TM_PRD_DIM_ID, 
CLS_BAL_AMT_LYR_LCY DN_NOIBANG_CUOI_NAM_TRUOC, 
CLS_BAL_AMT_TDY_LCY DN_NOIBANG, 
TANG_TRUONG, 
DN_TDH, 
TY_TRONG_DN_THD, 
DN_NT, 
TY_TRONG_DN_NT, 
DN_XAU, 
CLS_BAL_AMT_TO_WRT_OFF_LCY DN_CHUYEN_NGOAIBANG, 
OFF_BAL_PNP_PYMT_AMT_YTD_LCY NO_HTNB_DA_THU, 
TY_LE_NO_XAU_GOP, 
DN_NHOM_2, 
TY_TRONG_DN_NHOM_2, 
DN_QUA_HAN, 
DN_QUA_HAN_TREN_90, 
DN_QUA_HAN_TREN_90_KH_1_2, 
TY_TRONG_DN_QUA_HAN_TREN_90_KH_1_2, 
TOT_WRT_OFF_AMT_LCY, 
LAI_CHUA_THU, 
TY_TRONG_LAI_CHUA_THU_DN, 
LAI_TREO, 
TY_TRONG_LAI_TREO_DN, 
LAI_DU_THU, 
TY_TRONG_DU_THU_DN_NHOM_1, 
TY_TRONG_DU_THU_DN, 
LOI_NHUAN_RONG_TU_HDTD - (nvl(HOAN_NHAP,0) - nvl(CHI_PHI,0)) LOI_NHUAN_RONG_TU_HDTD_SAU_DPRR,
LOI_NHUAN_RONG_TU_HDTD, 
nvl(HOAN_NHAP,0) - nvl(CHI_PHI,0) PHAI_TRICH,
nvl(NO_QUY,0) NO_QUY, 
NIM, 
DU_NO_BINH_QUAN,
nvl(DPRR_CHUNG_N_1,0) DPRR_CHUNG_N_1, 
nvl(DPRR_CHUNG_N_1,0) - nvl(DU_QUY_N_1,0) TRICH_THIEU_N_1,
nvl(DPRR_CHUNG,0) DPRR_CHUNG, 
nvl(DPRR_CHUNG,0) - nvl(DU_QUY,0) TRICH_THIEU , 
nvl(DU_QUY,0) DU_QUY,
CASE WHEN DN_XAU = 0 THEN 0 ELSE nvl(DU_QUY,0) / DN_XAU END TY_LE_DU_QUY_DN_XAU, 
TYLE_NGOAIBANG_NOIBANG,
TY_LE_NO_XAU,
nvl(NO_QUY_N_1,0) NO_QUY_N_1

FROM
(
	select 
		DAY_LCY1.ORG_UNIT_DIM_ID ORG_UNIT_DIM_ID,
		DAY_LCY1.TM_PRD_DIM_ID TM_PRD_DIM_ID,
		sum(CASE WHEN LCS.LVL_1_CODE = '8' THEN 0 ELSE DAY_LCY2.CLS_BAL_AMT_LYR_LCY END) CLS_BAL_AMT_LYR_LCY,
		sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) CLS_BAL_AMT_TDY_LCY,
		sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY - CASE WHEN LCS.LVL_1_CODE = '8' THEN 0 ELSE DAY_LCY2.CLS_BAL_AMT_LYR_LCY END) TANG_TRUONG, 
		sum(case when gl_group.LVL_0_CODE not in ('11', '12','13','16', '17', '24', '33', '34','35',
		'38', '39', '46', '111', '112', '113','116', '117', '124', '134', '135', '138','139', '146',
		'822', '824', '825', '826', '827', '828', '829', '831', '832', '853','861', '211', '212', '213',
		'216', '217', '224', '233', '234', '235', '238', '239','246', '311', '312', '313', '316','317',
		'324', '333', '334', '335', '338', '339', '346',  '32', '150') then DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 end) DN_TDH,
		CASE WHEN sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0 THEN 0 ELSE sum(case when AR_TP.LVL_0_CODE = 'LN_AR' AND gl_group.LVL_0_CODE not in ('11', '12','13','16', '17', '24', '33', '34','35',
		'38', '39', '46', '111', '112', '113','116', '117', '124', '134', '135', '138','139', '146',
		'822', '824', '825', '826', '827', '828', '829', '831', '832', '853','861', '211', '212', '213',
		'216', '217', '224', '233', '234', '235', '238', '239','246', '311', '312', '313', '316','317',
		'324', '333', '334', '335', '338', '339', '346',  '32', '150') then DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 end) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) END TY_TRONG_DN_THD,
		SUM(CASE WHEN CCY.CCY_CODE <> 'VND' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END ) DN_NT,
		CASE WHEN sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0 THEN 0 ELSE SUM(CASE WHEN CCY.CCY_CODE <> 'VND' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) END TY_TRONG_DN_NT,
		sum(CASE WHEN PERF_ST_DIM.LVL_1_CODE IN (3) AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 end) DN_XAU,
		CASE WHEN sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0 THEN 0 ELSE sum(CASE WHEN PERF_ST_DIM.LVL_1_CODE IN (3) AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 end) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) END TY_LE_NO_XAU,
		sum(DAY_LCY1.CLS_BAL_AMT_TO_WRT_OFF_LCY) CLS_BAL_AMT_TO_WRT_OFF_LCY,
		sum(CASE WHEN PERF_ST_DIM.LVL_1_CODE IN (3) AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.OFF_BAL_PNP_PYMT_AMT_YTD_LCY ELSE 0 end) OFF_BAL_PNP_PYMT_AMT_YTD_LCY,
		case when sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0 then 0 else (sum(CASE WHEN PERF_ST_DIM.LVL_1_CODE IN (3) AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 end) + sum(DAY_LCY1.CLS_BAL_AMT_TO_WRT_OFF_LCY)) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) end TY_LE_NO_XAU_GOP,
		sum(CASE WHEN PERF_ST_DIM.LVL_1_CODE IN (2) AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 end) DN_NHOM_2,
		case when sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0 then 0 else sum(CASE WHEN PERF_ST_DIM.LVL_1_CODE IN (2) AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 end) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) end TY_TRONG_DN_NHOM_2,
		SUM(CASE WHEN FNC.LVL_0_CODE <> 'A' AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) DN_QUA_HAN,
		SUM(CASE WHEN FNC.LVL_0_CODE IN ('C','D','E') AND AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) DN_QUA_HAN_TREN_90,
		SUM(CASE WHEN FNC.LVL_0_CODE IN ('C','D','E') AND AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (1,2) THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) DN_QUA_HAN_TREN_90_KH_1_2,
		case when sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0 then 0 else SUM(CASE WHEN FNC.LVL_0_CODE IN ('C','D','E') AND AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (1,2) THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) end TY_TRONG_DN_QUA_HAN_TREN_90_KH_1_2,
		SUM(DAY_LCY1.TOT_WRT_OFF_AMT_LCY) TOT_WRT_OFF_AMT_LCY,
		SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.AST_ACR_INT_PTD_LCY + DAY_LCY1.AST_ACR_PNY_INT_AMT_PTD_LCY ELSE 0 END ) LAI_CHUA_THU,
		case when sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0 then 0 else SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.AST_ACR_INT_PTD_LCY + DAY_LCY1.AST_ACR_PNY_INT_AMT_PTD_LCY ELSE 0 END ) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) end TY_TRONG_LAI_CHUA_THU_DN,
		SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (2,3) THEN DAY_LCY1.AST_ACR_INT_PTD_LCY ELSE 0 END + CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.AST_ACR_PNY_INT_AMT_PTD_LCY ELSE 0 END) LAI_TREO,
		case when sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0  THEN 0 ELSE SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (2,3) THEN DAY_LCY1.AST_ACR_INT_PTD_LCY ELSE 0 END + CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.AST_ACR_PNY_INT_AMT_PTD_LCY ELSE 0 END) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) END TY_TRONG_LAI_TREO_DN,
		SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (1) THEN DAY_LCY1.AST_ACR_INT_PTD_LCY ELSE 0 END) LAI_DU_THU,
		CASE WHEN SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (1) THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (1) THEN DAY_LCY1.AST_ACR_INT_PTD_LCY ELSE 0 END) / SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (1) THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) END TY_TRONG_DU_THU_DN_NHOM_1,
		case when sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) = 0  THEN 0 ELSE SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' AND PERF_ST_DIM.LVL_1_CODE IN (1) THEN DAY_LCY1.AST_ACR_INT_PTD_LCY ELSE 0 END) / sum(DAY_LCY1.CLS_BAL_AMT_TDY_LCY) END TY_TRONG_DU_THU_DN,
		SUM(TNCP_HIST.AST_INT_INCM_YTD_LCY) LOI_NHUAN_RONG_TU_HDTD,
		CASE WHEN SUM(DAY_LCY1.AGRT_NIM_BAL_AMT_YTD_LCY) = 0 THEN 0 ELSE SUM(TNCP_HIST.AST_INT_INCM_YTD_LCY - FTP_DAY.AST_BSC_FTP_AMT_YTD_LCY - FTP_DAY.AST_AUTO_ADJ_FTP_AMT_YTD_LCY - FTP_DAY.AST_MNUL_ADJ_FTP_AMT_YTD_LCY) * 360 / SUM(DAY_LCY1.AGRT_NIM_BAL_AMT_YTD_LCY) END NIM,
		CASE WHEN MAX(DAY_LCY1.NBR_OF_DYS_YTD) = 0 THEN 0 ELSE SUM(DAY_LCY1.AGRT_BAL_AMT_YTD_LCY) / MAX(DAY_LCY1.NBR_OF_DYS_YTD) END DU_NO_BINH_QUAN,
		CASE WHEN SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) = 0 THEN 0 ELSE SUM(DAY_LCY1.TOT_WRT_OFF_AMT_LCY) / SUM(CASE WHEN AR_TP.LVL_0_CODE = 'LN_AR' THEN DAY_LCY1.CLS_BAL_AMT_TDY_LCY ELSE 0 END) END TYLE_NGOAIBANG_NOIBANG
	FROM AST_AR_ANL_FCT_DAY_LCY_1 DAY_LCY1 
	INNER JOIN CSTB_SYSTEM SYS ON SYS.PARAM_NAME = 'ETL_DATE'
	INNER JOIN 	SRC_STM_DIM ON DAY_LCY1.SRC_STM_DIM_ID = SRC_STM_DIM.SRC_STM_DIM_ID
	LEFT join 	ACG_STC_GRP_DIM gl_group on DAY_LCY1.ACG_STC_GRP_DIM_ID = gl_group.ACG_STC_GRP_DIM_ID
	LEFT JOIN 	AR_LC_ST_DIM LCS ON LCS.AR_LIFE_CYC_ST_DIM_ID = DAY_LCY1.AR_LCS_DIM_ID
	LEFT JOIN 	CCY_DIM CCY ON DAY_LCY1.CCY_DIM_ID = CCY.CCY_DM_ID
	LEFT JOIN 	PERF_ST_DIM ON PERF_ST_DIM.PERF_ST_DIM_ID = DAY_LCY1.CST_PERF_ST_DIM_ID
	LEFT JOIN 	AR_TP_DIM AR_TP ON AR_TP.AR_TP_DIM_ID = DAY_LCY1.AR_TP_DIM_ID
	LEFT JOIN 	AR_FNC_ST_DIM FNC ON FNC.AR_FNC_ST_DIM_ID = DAY_LCY1.AR_FNC_ST_DIM_ID
	
	LEFT JOIN 	AST_AR_ANL_FCT_DAY_LCY_2 DAY_LCY2 ON DAY_LCY1.AR_DIM_ID = DAY_LCY2.AR_DIM_ID AND DAY_LCY1.TM_PRD_DIM_ID = DAY_LCY2.TM_PRD_DIM_ID
	
	LEFT JOIN 	AST_AR_ANL_FCT_TNCP_ACR TNCP_HIST ON DAY_LCY1.AR_DIM_ID = TNCP_HIST.AR_DIM_ID AND DAY_LCY1.TM_PRD_DIM_ID = TNCP_HIST.TM_PRD_DIM_ID
	LEFT JOIN 	AST_AR_ANL_FTP_FCT_DAY	FTP_DAY ON DAY_LCY1.AR_DIM_ID = FTP_DAY.AR_DIM_ID AND DAY_LCY1.TM_PRD_DIM_ID = FTP_DAY.TM_PRD_DIM_ID
	WHERE DAY_LCY1.TM_PRD_DIM_ID = SYS.PARAM_VALUE AND SRC_STM_DIM.LVL_0_CODE IN ('SIBS_ODTIER','SIBS_LNMAST','CADENCIE_ACCT')
	AND (
	(AR_TP.LVL_0_CODE = 'LN_AR' AND 
	(
	(gl_group.LVL_0_CODE not in ('1','2','3','4','5','6','7','8','9','10','101','102','103','104','105','106',
	'107','108','109','110','125','126','127','128','129','823','49','50','51','52','501','502','503','504',
	'505','25','26','27','28','29')
	AND LCS.LVL_0_CODE <> '2' AND LCS.LVL_0_CODE <> '8') OR LCS.LVL_0_CODE = '8'
	)
	)
	OR (AR_TP.LVL_0_CODE = 'OD_AR' AND gl_group.LVL_0_CODE not in ('102','103'))
	OR AR_TP.LVL_0_CODE = 'CC_ACCT_AR')
	GROUP BY DAY_LCY1.ORG_UNIT_DIM_ID,DAY_LCY1.TM_PRD_DIM_ID
) AR_FCT
LEFT JOIN 
(	SELECT
		ORG_UNIT_DIM_ID,
		TM_PRD_DIM_ID,
		sum(TOT_GNL_PRVN_AMT_LCY) DPRR_CHUNG,
		SUM(TOT_SPF_PRVN_AMT_LCY) DPRR_CUTHE,
		SUM(PRVN_FND_DEFICIT_AMT_LCY) NO_QUY,
		SUM(PRVN_FND_AMT_LCY) DU_QUY,
		SUM(UNUSED_PRVN_REVERSED_AMT_LCY) HOAN_NHAP,
		SUM(PRVN_EXPN_AMT_LCY) CHI_PHI
	FROM 	CST_PRVN_ANL_FCT PRVN
	INNER JOIN CSTB_SYSTEM SYS ON SYS.PARAM_NAME = 'ETL_DATE'
	WHERE TM_PRD_DIM_ID = SYS.PARAM_VALUE
	GROUP BY ORG_UNIT_DIM_ID,TM_PRD_DIM_ID,SYS.PARAM_VALUE
)PRVN_FCT ON AR_FCT.ORG_UNIT_DIM_ID = PRVN_FCT.ORG_UNIT_DIM_ID
left join 
(	SELECT
		ORG_UNIT_DIM_ID,
		TM_PRD_DIM_ID,
		sum(CASE WHEN TM_PRD_DIM_ID = TO_NUMBER(TO_CHAR(DATE_TRUNC('YEAR',TO_DATE(SYS.PARAM_VALUE,'YYYYDDD'))-1,'YYYYDDD'),9999999) THEN TOT_GNL_PRVN_AMT_LCY ELSE 0 END) DPRR_CHUNG_N_1,
		sum(CASE WHEN TM_PRD_DIM_ID = TO_NUMBER(TO_CHAR(DATE_TRUNC('YEAR',TO_DATE(SYS.PARAM_VALUE,'YYYYDDD'))-1,'YYYYDDD'),9999999) THEN TOT_SPF_PRVN_AMT_LCY ELSE 0 END) DPRR_CUTHE_N_1,
		sum(CASE WHEN TM_PRD_DIM_ID = TO_NUMBER(TO_CHAR(DATE_TRUNC('YEAR',TO_DATE(SYS.PARAM_VALUE,'YYYYDDD'))-1,'YYYYDDD'),9999999) THEN PRVN_FND_DEFICIT_AMT_LCY ELSE 0 END) NO_QUY_N_1,
		sum(CASE WHEN TM_PRD_DIM_ID = TO_NUMBER(TO_CHAR(DATE_TRUNC('YEAR',TO_DATE(SYS.PARAM_VALUE,'YYYYDDD'))-1,'YYYYDDD'),9999999) THEN PRVN_FND_AMT_LCY ELSE 0 END) DU_QUY_N_1,
		sum(CASE WHEN TM_PRD_DIM_ID = TO_NUMBER(TO_CHAR(DATE_TRUNC('YEAR',TO_DATE(SYS.PARAM_VALUE,'YYYYDDD'))-1,'YYYYDDD'),9999999) THEN UNUSED_PRVN_REVERSED_AMT_LCY ELSE 0 END) HOAN_NHAP_N_1,
		sum(CASE WHEN TM_PRD_DIM_ID = TO_NUMBER(TO_CHAR(DATE_TRUNC('YEAR',TO_DATE(SYS.PARAM_VALUE,'YYYYDDD'))-1,'YYYYDDD'),9999999) THEN PRVN_EXPN_AMT_LCY ELSE 0 END) CHI_PHI_N_1
	FROM 	CST_PRVN_ANL_FCT PRVN
	INNER JOIN CSTB_SYSTEM SYS ON SYS.PARAM_NAME = 'ETL_DATE'
	WHERE TM_PRD_DIM_ID = TO_NUMBER(TO_CHAR(DATE_TRUNC('YEAR',TO_DATE(SYS.PARAM_VALUE,'YYYYDDD'))-1,'YYYYDDD'),9999999)
	GROUP BY ORG_UNIT_DIM_ID,TM_PRD_DIM_ID,SYS.PARAM_VALUE
)PRVN_FCT_N_1 on AR_FCT.ORG_UNIT_DIM_ID = PRVN_FCT_N_1.ORG_UNIT_DIM_ID;

