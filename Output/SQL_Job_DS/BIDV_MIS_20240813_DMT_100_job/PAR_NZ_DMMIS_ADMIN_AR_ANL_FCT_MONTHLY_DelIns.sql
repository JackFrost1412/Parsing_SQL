DELETE FROM DMMIS.ADMIN.AR_ANL_FCT_MONTHLY
WHERE TM_PRD_DIM_ID = :pDate:;

INSERT INTO AR_ANL_FCT_MONTHLY
(
		TM_PRD_DIM_ID,
		PD_DIM_ID,
		SRC_STM_DIM_ID,
		AR_TP_DIM_ID,
		PDM_DIM_ID,
		CCY_DIM_ID,
		CST_TP_DIM_ID,
		ORG_UNIT_DIM_ID,
		BAL_ACG_STC_ITM_DIM_ID,
		ACG_STC_GRP_DIM_ID,
		CST_DIM_ID,
		IDY_SML_ID_DIM_ID,
		CST_PERF_ST_DIM_ID,
		CST_SEG_DIM_ID,
		CST_LIFE_CYC_ST_DIM_ID,
		CR_RSK_RTG_DIM_ID,
		AR_FNC_ST_DIM_ID,
		AR_DIM_ID,
		AR_PPS_DIM_ID,
		AR_LCS_DIM_ID,
		RMAN_TM_TO_MAT_SEG_DIM_ID,
		ORIG_TM_TO_MAT_SEG_DIM_ID,
		ACT_TM_TO_MAT_SEG_DIM_ID,
		AR_OFCR_EMPE_DIM_ID,
		AR_MGT_DEPT_DIM_ID,
		CST_OFCR_EMPE_DIM_ID,
		CST_MGT_DEPT_DIM_ID,
		AR_ID,
		CST_ID,
		TOT_NET_INCM_SEG_DIM_ID,
		CLS_BAL_AMT_TDY_FCY,
		CLS_BAL_AMT_TDY_LCY,
		CLS_ON_BAL_AMT_TDY_FCY,
		CLS_ON_BAL_AMT_TDY_LCY,
		TOT_PAST_DUE_PNP_AMT_FCY,
		TOT_PAST_DUE_PNP_AMT_LCY,
		ACT_INT_RATE_TDY,
		BSC_FTP_RATE_TDY,
		ADL_FTP_RATE_TDY,
		AGRT_NIM_BAL_AMT_TDY_LCY,
		AST_INT_PYMT_AMT_TDY_FCY,
		AST_INT_PYMT_AMT_TDY_LCY,
		DSBR_AMT_TDY_FCY,
		DSBR_AMT_TDY_LCY,
		PNP_PYMT_AMT_TDY_FCY,
		PNP_PYMT_AMT_TDY_LCY,
		PAST_DUE_INT_NBR_OF_DYS,
		PAST_DUE_PNP_NBR_OF_DYS,
		ACR_INT_TDY_FCY,
		ACR_INT_TDY_LCY,
		ACR_PNY_INT_TDY_FCY,
		ACR_PNY_INT_TDY_LCY,
		ACR_INT_PTD_FCY,
		ACR_PNY_INT_PTD_FCY,
		ACR_PNY_INT_PTD_LCY,
		TOT_PAST_DUE_INT_AMT_FCY,
		TOT_PAST_DUE_INT_AMT_LCY,
		TOT_LMT_AMT_FCY,
		TOT_LMT_AMT_LCY,
		AGRT_BAL_AMT_MTD_LCY,
		AGRT_BAL_AMT_MTD_FCY,
				AGRT_BSC_FTP_RATE_MTD,
		AGRT_ADL_FTP_RATE_MTD,
		AGRT_NIM_BAL_AMT_MTD_LCY,
		AST_INT_PYMT_AMT_MTD_FCY,
		AST_INT_PYMT_AMT_MTD_LCY,
		DSBR_AMT_MTD_FCY,
		DSBR_AMT_MTD_LCY,
		PNP_PYMT_AMT_MTD_FCY,
		PNP_PYMT_AMT_MTD_LCY,
		ACR_INT_MTD_FCY,
		ACR_INT_MTD_LCY,
		ACR_PNY_INT_MTD_FCY,
		ACR_PNY_INT_MTD_LCY,
      	NBR_OF_DYS_HTD,
        NBR_OF_DYS_MTD,
        NBR_OF_DYS_QTD,
        NBR_OF_DYS_YTD

)
WITH fct as(
	SELECT 
		CAST(:pDate:	AS INTEGER) TM_PRD_DIM_ID,
		fct.PD_DIM_ID,
		fct.SRC_STM_DIM_ID,
		fct.AR_TP_DIM_ID,
		CAST(NVL(PDM_DIM.PDM_DIM_ID,999999) AS INTEGER)  PDM_DIM_ID,
		fct.CCY_DIM_ID,
		fct.CST_TP_DIM_ID,
		fct.ORG_UNIT_DIM_ID,
		fct.BAL_ACG_STC_ITM_DIM_ID,
		fct.ACG_STC_GRP_DIM_ID,
		fct.CST_DIM_ID,
		fct.IDY_SML_ID_DIM_ID,
		fct.CST_PERF_ST_DIM_ID,
		fct.CST_SEG_DIM_ID,
		fct.CST_LIFE_CYC_ST_DIM_ID,
		fct.CR_RSK_RTG_DIM_ID,
		fct.AR_FNC_ST_DIM_ID,
		fct.AR_DIM_ID,
		fct.AR_PPS_DIM_ID,
		fct.AR_LCS_DIM_ID,
		fct.RMAN_TM_TO_MAT_SEG_DIM_ID,
		fct.ORIG_TM_TO_MAT_SEG_DIM_ID,
		fct.ACT_TM_TO_MAT_SEG_DIM_ID,
		fct.AR_OFCR_EMPE_DIM_ID,
		fct.AR_MGT_DEPT_DIM_ID,
		fct.CST_OFCR_EMPE_DIM_ID,
		fct.CST_MGT_DEPT_DIM_ID,
		fct.AR_ID,
		fct.CST_ID,
		fct.TOT_NET_INCM_SEG_DIM_ID,
		CAST(SUM(fct.CLS_BAL_AMT_TDY_LCY) AS DECIMAL(23,2)) AGRT_BAL_AMT_MTD_LCY,
		CAST(SUM(fct.CLS_BAL_AMT_TDY_FCY) AS DECIMAL(19,2)) AGRT_BAL_AMT_MTD_FCY,
				CAST(SUM(fct.BSC_FTP_RATE_TDY * fct.CLS_BAL_AMT_TDY_LCY) AS DECIMAL(24,2)) AGRT_BSC_FTP_RATE_MTD,
		CAST(SUM(fct.ADL_FTP_RATE_TDY * fct.CLS_BAL_AMT_TDY_LCY) AS DECIMAL(24,2)) AGRT_ADL_FTP_RATE_MTD,
		CAST(SUM(fct.CLS_BAL_AMT_TDY_LCY) AS DECIMAL(23,2)) AGRT_NIM_BAL_AMT_MTD_LCY,
		CAST(SUM(fct.AST_INT_PYMT_AMT_TDY_FCY) AS DECIMAL(20,2)) AST_INT_PYMT_AMT_MTD_FCY,
		CAST(SUM(fct.AST_INT_PYMT_AMT_TDY_LCY) AS DECIMAL(24,2)) AST_INT_PYMT_AMT_MTD_LCY,
		CAST(SUM(fct.DSBR_AMT_TDY_FCY) AS DECIMAL(19,2)) DSBR_AMT_MTD_FCY,
		CAST(SUM(fct.DSBR_AMT_TDY_LCY) AS DECIMAL(23,2)) DSBR_AMT_MTD_LCY,
		CAST(SUM(fct.PNP_PYMT_AMT_TDY_FCY) AS DECIMAL(20,2)) PNP_PYMT_AMT_MTD_FCY,
		CAST(SUM(fct.PNP_PYMT_AMT_TDY_LCY) AS DECIMAL(24,2)) PNP_PYMT_AMT_MTD_LCY,
		CAST(SUM(fct.ACR_INT_TDY_FCY) AS DECIMAL(20,2)) ACR_INT_MTD_FCY,
		CAST(SUM(fct.ACR_INT_TDY_LCY) AS DECIMAL(24,2)) ACR_INT_MTD_LCY,
		CAST(SUM(fct.ACR_PNY_INT_TDY_FCY) AS DECIMAL(20,2)) ACR_PNY_INT_MTD_FCY,
		CAST(SUM(fct.ACR_PNY_INT_TDY_LCY) AS DECIMAL(24,2)) ACR_PNY_INT_MTD_LCY,
		max(NBR_OF_DYS_HTD)		NBR_OF_DYS_HTD,
        max(NBR_OF_DYS_MTD)		NBR_OF_DYS_MTD,
        max(NBR_OF_DYS_QTD)		NBR_OF_DYS_QTD,
        max(NBR_OF_DYS_YTD)	 	NBR_OF_DYS_YTD
				
	FROM DMMIS.ADMIN.AR_ANL_FCT_FULL FCT
	INNER JOIN PD_DIM ON FCT.PD_DIM_ID  = PD_DIM.PD_DIM_ID
	LEFT  JOIN PDM_DIM ON PD_DIM.PDM_DIM_ID = PDM_DIM.PDM_CODE
	WHERE TO_DATE(FCT.TM_PRD_DIM_ID,'YYYYDDD') >= DATE_TRUNC('month',TO_DATE(:pDate:,'YYYYDDD'))
	AND	  TO_DATE(FCT.TM_PRD_DIM_ID,'YYYYDDD') <= TO_DATE(:pDate:,'YYYYDDD')

		GROUP BY
		fct.PD_DIM_ID,
		fct.SRC_STM_DIM_ID,
		fct.AR_TP_DIM_ID,
		fct.CCY_DIM_ID,
		fct.CST_TP_DIM_ID,
		fct.ORG_UNIT_DIM_ID,
		fct.BAL_ACG_STC_ITM_DIM_ID,
		fct.ACG_STC_GRP_DIM_ID,
		fct.CST_DIM_ID,
		fct.IDY_SML_ID_DIM_ID,
		fct.CST_PERF_ST_DIM_ID,
		fct.CST_SEG_DIM_ID,
		fct.CST_LIFE_CYC_ST_DIM_ID,
		fct.CR_RSK_RTG_DIM_ID,
		fct.AR_FNC_ST_DIM_ID,
		fct.AR_DIM_ID,
		fct.AR_PPS_DIM_ID,
		fct.AR_LCS_DIM_ID,
		fct.RMAN_TM_TO_MAT_SEG_DIM_ID,
		fct.ORIG_TM_TO_MAT_SEG_DIM_ID,
		fct.ACT_TM_TO_MAT_SEG_DIM_ID,
		fct.AR_OFCR_EMPE_DIM_ID,
		fct.AR_MGT_DEPT_DIM_ID,
		fct.CST_OFCR_EMPE_DIM_ID,
		fct.CST_MGT_DEPT_DIM_ID,
		fct.AR_ID,
		fct.CST_ID,
		fct.TOT_NET_INCM_SEG_DIM_ID,
		PDM_DIM.PDM_DIM_ID
)

SELECT
		CAST(:pDate:	AS INTEGER) TM_PRD_DIM_ID,
		fct.PD_DIM_ID,
		fct.SRC_STM_DIM_ID,
		fct.AR_TP_DIM_ID,
		fct.PDM_DIM_ID,
		fct.CCY_DIM_ID,
		fct.CST_TP_DIM_ID,
		fct.ORG_UNIT_DIM_ID,
		fct.BAL_ACG_STC_ITM_DIM_ID,
		fct.ACG_STC_GRP_DIM_ID,
		fct.CST_DIM_ID,
		fct.IDY_SML_ID_DIM_ID,
		fct.CST_PERF_ST_DIM_ID,
		fct.CST_SEG_DIM_ID,
		fct.CST_LIFE_CYC_ST_DIM_ID,
		fct.CR_RSK_RTG_DIM_ID,
		fct.AR_FNC_ST_DIM_ID,
		fct.AR_DIM_ID,
		fct.AR_PPS_DIM_ID,
		fct.AR_LCS_DIM_ID,
		fct.RMAN_TM_TO_MAT_SEG_DIM_ID,
		fct.ORIG_TM_TO_MAT_SEG_DIM_ID,
		fct.ACT_TM_TO_MAT_SEG_DIM_ID,
		fct.AR_OFCR_EMPE_DIM_ID,
		fct.AR_MGT_DEPT_DIM_ID,
		fct.CST_OFCR_EMPE_DIM_ID,
		fct.CST_MGT_DEPT_DIM_ID,
		fct.AR_ID,
		fct.CST_ID,
		fct.TOT_NET_INCM_SEG_DIM_ID,
		DLY.CLS_BAL_AMT_TDY_FCY,
		DLY.CLS_BAL_AMT_TDY_LCY,
		DLY.CLS_ON_BAL_AMT_TDY_FCY,
		DLY.CLS_ON_BAL_AMT_TDY_LCY,
		DLY.TOT_PAST_DUE_PNP_AMT_FCY,
		DLY.TOT_PAST_DUE_PNP_AMT_LCY,
		DLY.ACT_INT_RATE_TDY,
		DLY.BSC_FTP_RATE_TDY,
		DLY.ADL_FTP_RATE_TDY,
		DLY.AGRT_NIM_BAL_AMT_TDY_LCY,
		DLY.AST_INT_PYMT_AMT_TDY_FCY,
		DLY.AST_INT_PYMT_AMT_TDY_LCY,
		DLY.DSBR_AMT_TDY_FCY,
		DLY.DSBR_AMT_TDY_LCY,
		DLY.PNP_PYMT_AMT_TDY_FCY,
		DLY.PNP_PYMT_AMT_TDY_LCY,
		DLY.PAST_DUE_INT_NBR_OF_DYS,
		DLY.PAST_DUE_PNP_NBR_OF_DYS,
		DLY.ACR_INT_TDY_FCY,
		DLY.ACR_INT_TDY_LCY,
		DLY.ACR_PNY_INT_TDY_FCY,
		DLY.ACR_PNY_INT_TDY_LCY,
		DLY.ACR_INT_PTD_FCY,
		DLY.ACR_PNY_INT_PTD_FCY,
		DLY.ACR_PNY_INT_PTD_LCY,
		DLY.TOT_PAST_DUE_INT_AMT_FCY,
		DLY.TOT_PAST_DUE_INT_AMT_LCY,
		DLY.TOT_LMT_AMT_FCY,
		DLY.TOT_LMT_AMT_LCY,

		fct.AGRT_BAL_AMT_MTD_LCY,
		fct.AGRT_BAL_AMT_MTD_FCY,
				fct.AGRT_BSC_FTP_RATE_MTD,
		fct.AGRT_ADL_FTP_RATE_MTD,
		fct.AGRT_NIM_BAL_AMT_MTD_LCY,
		fct.AST_INT_PYMT_AMT_MTD_FCY,
		fct.AST_INT_PYMT_AMT_MTD_LCY,
		fct.DSBR_AMT_MTD_FCY,
		fct.DSBR_AMT_MTD_LCY,
		fct.PNP_PYMT_AMT_MTD_FCY,
		fct.PNP_PYMT_AMT_MTD_LCY,
		fct.ACR_INT_MTD_FCY,
		fct.ACR_INT_MTD_LCY,
		fct.ACR_PNY_INT_MTD_FCY,
		fct.ACR_PNY_INT_MTD_LCY,
        fct.NBR_OF_DYS_HTD,
        fct.NBR_OF_DYS_MTD,
        fct.NBR_OF_DYS_QTD,
        fct.NBR_OF_DYS_YTD
				

FROM  FCT

LEFT JOIN AR_ANL_FCT_FULL_daily dly	ON 
fct.PD_DIM_ID		=	dly.PD_DIM_ID
and	fct.SRC_STM_DIM_ID	=	dly.SRC_STM_DIM_ID
and	fct.AR_TP_DIM_ID	=	dly.AR_TP_DIM_ID
and	fct.CCY_DIM_ID		=	dly.CCY_DIM_ID
and	fct.CST_TP_DIM_ID	=	dly.CST_TP_DIM_ID
and	fct.ORG_UNIT_DIM_ID	=	dly.ORG_UNIT_DIM_ID
and	fct.BAL_ACG_STC_ITM_DIM_ID	=	dly.BAL_ACG_STC_ITM_DIM_ID
and	fct.ACG_STC_GRP_DIM_ID	=	dly.ACG_STC_GRP_DIM_ID
and	fct.CST_DIM_ID		=	dly.CST_DIM_ID
and	fct.IDY_SML_ID_DIM_ID	=	dly.IDY_SML_ID_DIM_ID
and	fct.CST_PERF_ST_DIM_ID	=	dly.CST_PERF_ST_DIM_ID
and	fct.CST_SEG_DIM_ID		=	dly.CST_SEG_DIM_ID
and	fct.CST_LIFE_CYC_ST_DIM_ID	=	dly.CST_LIFE_CYC_ST_DIM_ID
and	fct.CR_RSK_RTG_DIM_ID	=	dly.CR_RSK_RTG_DIM_ID
and	fct.AR_FNC_ST_DIM_ID	=	dly.AR_FNC_ST_DIM_ID
and	fct.AR_DIM_ID			=	dly.AR_DIM_ID
and	fct.AR_PPS_DIM_ID		=	dly.AR_PPS_DIM_ID
and	fct.AR_LCS_DIM_ID		=	dly.AR_LCS_DIM_ID
and	fct.RMAN_TM_TO_MAT_SEG_DIM_ID	=	dly.RMAN_TM_TO_MAT_SEG_DIM_ID
and	fct.ORIG_TM_TO_MAT_SEG_DIM_ID	=	dly.ORIG_TM_TO_MAT_SEG_DIM_ID
and	fct.ACT_TM_TO_MAT_SEG_DIM_ID	=	dly.ACT_TM_TO_MAT_SEG_DIM_ID
and	fct.AR_OFCR_EMPE_DIM_ID		=	dly.AR_OFCR_EMPE_DIM_ID
and	fct.AR_MGT_DEPT_DIM_ID		=	dly.AR_MGT_DEPT_DIM_ID
and	fct.CST_OFCR_EMPE_DIM_ID	=	dly.CST_OFCR_EMPE_DIM_ID
and	fct.CST_MGT_DEPT_DIM_ID		=	dly.CST_MGT_DEPT_DIM_ID
and	fct.AR_ID		=	dly.AR_ID
and	fct.CST_ID		=	dly.CST_ID
and	fct.TOT_NET_INCM_SEG_DIM_ID =	dly.TOT_NET_INCM_SEG_DIM_ID;

