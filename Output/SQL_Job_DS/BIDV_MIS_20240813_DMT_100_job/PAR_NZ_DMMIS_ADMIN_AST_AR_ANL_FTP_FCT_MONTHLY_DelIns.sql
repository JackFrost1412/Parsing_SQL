DELETE FROM AST_AR_ANL_FTP_FCT_MONTHLY WHERE TM_PRD_DIM_ID = :pDate:;

INSERT INTO AST_AR_ANL_FTP_FCT_MONTHLY
(	
	  AR_ID,
	  CR_RSK_RTG_DIM_ID,
	  ACG_STC_GRP_DIM_ID,
	  AR_OFCR_EMPE_DIM_ID,
	  CST_SEG_DIM_ID,
	  CST_OFCR_EMPE_DIM_ID,
	  AR_DIM_ID,
	  AR_FNC_ST_DIM_ID,
	  AR_LCS_DIM_ID,
	  AR_PPS_DIM_ID,
	  AR_TP_DIM_ID,
	  BAL_ACG_STC_ITM_DIM_ID,
	  CST_DIM_ID,
	  CST_PERF_ST_DIM_ID,
	  CST_TP_DIM_ID,
	  ORG_UNIT_DIM_ID,
	  ORIG_TM_TO_MAT_SEG_DIM_ID,
	  PD_DIM_ID,
	  PDM_DIM_ID,
	  SRC_STM_DIM_ID,
	  TM_PRD_DIM_ID,
	  AR_OFCR_CREATOR_DIM_ID,
	  CST_OFCR_CREATOR_DIM_ID,
	  AR_CRT_DEPT_DIM_ID,
	  AR_MGT_DEPT_DIM_ID,
	  CST_CRT_DEPT_DIM_ID,
	  CST_MGT_DEPT_DIM_ID,
	  CST_ID,
	  CST_PERF_CARD_ST_DIM_ID,
	  AST_BSC_FTP_RATE_TDY,
	  AST_ADL_FTP_RATE_TDY,
	  AST_AUTO_ADJ_FTP_AMT_MTD_FCY,
	  AST_AUTO_ADJ_FTP_AMT_MTD_LCY,
	  AST_AUTO_ADJ_FTP_AMT_TDY_FCY,
	  AST_AUTO_ADJ_FTP_AMT_TDY_LCY,
	  AST_BSC_FTP_AMT_MTD_FCY,
	  AST_BSC_FTP_AMT_MTD_LCY,
	  AST_BSC_FTP_AMT_TDY_FCY,
	  AST_BSC_FTP_AMT_TDY_LCY,
	  FTP_TERM_CODE_DIM_ID,
	  FTP_CD_TP_DIM_ID,
	  FTP_CD_CODE_DIM_ID,
	  CCY_DIM_ID
)
WITH FCT AS (
 SELECT 
	  AR_ID,
	  CR_RSK_RTG_DIM_ID,
	  ACG_STC_GRP_DIM_ID,
	  AR_OFCR_EMPE_DIM_ID,
	  CST_SEG_DIM_ID,
	  CST_OFCR_EMPE_DIM_ID,
	  AR_DIM_ID,
	  AR_FNC_ST_DIM_ID,
	  AR_LCS_DIM_ID,
	  AR_PPS_DIM_ID,
	  AR_TP_DIM_ID,
	  BAL_ACG_STC_ITM_DIM_ID,
	  CST_DIM_ID,
	  CST_PERF_ST_DIM_ID,
	  CST_TP_DIM_ID,
	  ORG_UNIT_DIM_ID,
	  ORIG_TM_TO_MAT_SEG_DIM_ID,
	  FCT.PD_DIM_ID,
	  PDM_DIM.PDM_DIM_ID,
	  SRC_STM_DIM_ID,
	  :pDate:   TM_PRD_DIM_ID,
	  AR_OFCR_CREATOR_DIM_ID,
	  CST_OFCR_CREATOR_DIM_ID,
	  AR_CRT_DEPT_DIM_ID,
	  AR_MGT_DEPT_DIM_ID,
	  CST_CRT_DEPT_DIM_ID,
	  CST_MGT_DEPT_DIM_ID,
	  CST_ID,
	  CST_PERF_CARD_ST_DIM_ID,
	  SUM(AST_AUTO_ADJ_FTP_AMT_TDY_FCY)  AST_AUTO_ADJ_FTP_AMT_MTD_FCY,
	  SUM(AST_AUTO_ADJ_FTP_AMT_TDY_LCY)  AST_AUTO_ADJ_FTP_AMT_MTD_LCY,
	  SUM(AST_BSC_FTP_AMT_TDY_FCY)   AST_BSC_FTP_AMT_MTD_FCY,
	  SUM(AST_BSC_FTP_AMT_TDY_LCY)   AST_BSC_FTP_AMT_MTD_LCY,
	  FTP_TERM_CODE_DIM_ID,
	  FTP_CD_TP_DIM_ID,
	  FTP_CD_CODE_DIM_ID,
	  CCY_DIM_ID
 FROM AST_AR_ANL_FTP_FCT_DAY FCT
 LEFT JOIN PD_DIM ON PD_DIM.PD_DIM_ID  = FCT.PD_DIM_ID 
 LEFT JOIN PDM_DIM ON PD_DIM.PDM_DIM_ID =  PDM_DIM.PDM_CODE
 WHERE TO_DATE(TM_PRD_DIM_ID,'YYYYDDD') >= DATE_TRUNC('MONTH',TO_DATE(:pDate:,'YYYYDDD'))
 AND  TO_DATE(TM_PRD_DIM_ID,'YYYYDDD') <=TO_DATE(:pDate:,'YYYYDDD')
 GROUP BY AR_ID,
		  CR_RSK_RTG_DIM_ID,
		  ACG_STC_GRP_DIM_ID,
		  AR_OFCR_EMPE_DIM_ID,
		  CST_SEG_DIM_ID,
		  CST_OFCR_EMPE_DIM_ID,
		  AR_DIM_ID,
		  AR_FNC_ST_DIM_ID,
		  AR_LCS_DIM_ID,
		  AR_PPS_DIM_ID,
		  AR_TP_DIM_ID,
		  BAL_ACG_STC_ITM_DIM_ID,
		  CST_DIM_ID,
		  CST_PERF_ST_DIM_ID,
		  CST_TP_DIM_ID,
		  ORG_UNIT_DIM_ID,
		  ORIG_TM_TO_MAT_SEG_DIM_ID,
		  FCT.PD_DIM_ID,
		  SRC_STM_DIM_ID,
		  AR_OFCR_CREATOR_DIM_ID,
		  CST_OFCR_CREATOR_DIM_ID,
		  AR_CRT_DEPT_DIM_ID,
		  AR_MGT_DEPT_DIM_ID,
		  CST_CRT_DEPT_DIM_ID,
		  CST_MGT_DEPT_DIM_ID,
		  CST_ID,
		  CST_PERF_CARD_ST_DIM_ID,
		  FTP_TERM_CODE_DIM_ID,
		  FTP_CD_TP_DIM_ID,
		  FTP_CD_CODE_DIM_ID,
		  CCY_DIM_ID,
		  PDM_DIM.PDM_DIM_ID
 )
SELECT
  FCT.AR_ID,
  FCT.CR_RSK_RTG_DIM_ID,
  FCT.ACG_STC_GRP_DIM_ID,
  FCT.AR_OFCR_EMPE_DIM_ID,
  FCT.CST_SEG_DIM_ID,
  FCT.CST_OFCR_EMPE_DIM_ID,
  FCT.AR_DIM_ID,
  FCT.AR_FNC_ST_DIM_ID,
  FCT.AR_LCS_DIM_ID,
  FCT.AR_PPS_DIM_ID,
  FCT.AR_TP_DIM_ID,
  FCT.BAL_ACG_STC_ITM_DIM_ID,
  FCT.CST_DIM_ID,
  FCT.CST_PERF_ST_DIM_ID,
  FCT.CST_TP_DIM_ID,
  FCT.ORG_UNIT_DIM_ID,
  FCT.ORIG_TM_TO_MAT_SEG_DIM_ID,
  FCT.PD_DIM_ID,
  NVL(FCT.PDM_DIM_ID,999999)  PDM_DIM_ID,
  FCT.SRC_STM_DIM_ID,
  FCT.TM_PRD_DIM_ID,
  FCT.AR_OFCR_CREATOR_DIM_ID,
  FCT.CST_OFCR_CREATOR_DIM_ID,
  FCT.AR_CRT_DEPT_DIM_ID,
  FCT.AR_MGT_DEPT_DIM_ID,
  FCT.CST_CRT_DEPT_DIM_ID,
  FCT.CST_MGT_DEPT_DIM_ID,
  FCT.CST_ID,
  FCT.CST_PERF_CARD_ST_DIM_ID,
  NVL(DLY.AST_BSC_FTP_RATE_TDY,0)	AST_BSC_FTP_RATE_TDY,
  NVL(DLY.AST_ADL_FTP_RATE_TDY,0)	AST_ADL_FTP_RATE_TDY,
  FCT.AST_AUTO_ADJ_FTP_AMT_MTD_FCY,
  FCT.AST_AUTO_ADJ_FTP_AMT_MTD_LCY,
  NVL(DLY.AST_AUTO_ADJ_FTP_AMT_TDY_FCY,0)	AST_AUTO_ADJ_FTP_AMT_TDY_FCY,
  NVL(DLY.AST_AUTO_ADJ_FTP_AMT_TDY_LCY,0)	AST_AUTO_ADJ_FTP_AMT_TDY_LCY,
  FCT.AST_BSC_FTP_AMT_MTD_FCY,
  FCT.AST_BSC_FTP_AMT_MTD_LCY,
  NVL(DLY.AST_BSC_FTP_AMT_TDY_FCY,0)	AST_BSC_FTP_AMT_TDY_FCY,
  NVL(DLY.AST_BSC_FTP_AMT_TDY_LCY,0)	AST_BSC_FTP_AMT_TDY_LCY,
  FCT.FTP_TERM_CODE_DIM_ID,
  FCT.FTP_CD_TP_DIM_ID,
  FCT.FTP_CD_CODE_DIM_ID,
  FCT.CCY_DIM_ID
       FROM FCT
LEFT JOIN AST_AR_ANL_FTP_FCT_DAY_DAILY DLY 
ON  FCT.AR_ID		= DLY.AR_ID 
	AND FCT.CR_RSK_RTG_DIM_ID 	=	DLY.CR_RSK_RTG_DIM_ID
	AND	FCT.ACG_STC_GRP_DIM_ID  =	DLY.ACG_STC_GRP_DIM_ID
	AND	FCT.AR_OFCR_EMPE_DIM_ID =	DLY.AR_OFCR_EMPE_DIM_ID
	AND	FCT.CST_SEG_DIM_ID		=	DLY.CST_SEG_DIM_ID
	AND	FCT.CST_OFCR_EMPE_DIM_ID = 	DLY.CST_OFCR_EMPE_DIM_ID
    AND	FCT.AR_DIM_ID			= 	DLY.AR_DIM_ID
	AND	FCT.AR_FNC_ST_DIM_ID	=	DLY.AR_FNC_ST_DIM_ID
	AND	FCT.AR_LCS_DIM_ID		=	DLY.AR_LCS_DIM_ID
	AND	FCT.AR_PPS_DIM_ID		=	DLY.AR_PPS_DIM_ID
	AND	FCT.AR_TP_DIM_ID		=	DLY.AR_TP_DIM_ID
	AND	FCT.BAL_ACG_STC_ITM_DIM_ID	=	DLY.BAL_ACG_STC_ITM_DIM_ID
	AND	FCT.CST_DIM_ID			=	DLY.CST_DIM_ID
	AND	FCT.CST_PERF_ST_DIM_ID	=	DLY.CST_PERF_ST_DIM_ID
	AND	FCT.CST_TP_DIM_ID		=	DLY.CST_TP_DIM_ID
	AND	FCT.ORG_UNIT_DIM_ID		=	DLY.ORG_UNIT_DIM_ID
	AND	FCT.ORIG_TM_TO_MAT_SEG_DIM_ID	=	DLY.ORIG_TM_TO_MAT_SEG_DIM_ID
		AND	FCT.SRC_STM_DIM_ID		= 	DLY.SRC_STM_DIM_ID
	AND	FCT.AR_OFCR_CREATOR_DIM_ID	= 	DLY.AR_OFCR_CREATOR_DIM_ID
	AND	FCT.CST_OFCR_CREATOR_DIM_ID	=	DLY.CST_OFCR_CREATOR_DIM_ID
	AND	FCT.AR_CRT_DEPT_DIM_ID		=	DLY.AR_CRT_DEPT_DIM_ID
	AND	FCT.AR_MGT_DEPT_DIM_ID		=	DLY.AR_MGT_DEPT_DIM_ID
	AND	FCT.CST_CRT_DEPT_DIM_ID		= 	DLY.CST_CRT_DEPT_DIM_ID
	AND	FCT.CST_MGT_DEPT_DIM_ID		=	DLY.CST_MGT_DEPT_DIM_ID
	AND	FCT.CST_ID					=	DLY.CST_ID
	AND	FCT.CST_PERF_CARD_ST_DIM_ID	=	DLY.CST_PERF_CARD_ST_DIM_ID
	AND FCT.FTP_TERM_CODE_DIM_ID	=	DLY.FTP_TERM_CODE_DIM_ID
	AND	FCT.FTP_CD_TP_DIM_ID		=	DLY.FTP_CD_TP_DIM_ID
	AND	FCT.FTP_CD_CODE_DIM_ID		=	DLY.FTP_CD_CODE_DIM_ID
	AND FCT.CCY_DIM_ID				= 	DLY.CCY_DIM_ID
	--PDM_DIM.PDM_DIM_ID;

