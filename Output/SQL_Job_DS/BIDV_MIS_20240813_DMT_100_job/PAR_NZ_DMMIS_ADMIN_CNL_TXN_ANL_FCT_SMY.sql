DELETE FROM  CNL_TXN_ANL_FCT_SMY WHERE  CDR_DIM_ID=:pDate:;

INSERT INTO CNL_TXN_ANL_FCT_SMY
(
	 CST_TP_DIM_ID, 
     CDR_DIM_ID, 
     CNL_DIM_ID, 
     CNL_TP_DIM_ID, 
     CTY_OF_TXN_DIM_ID, 
     CCY_DIM_ID, 
     CST_DIM_ID, 
     PRIM_AR_DIM_ID, 
     PRIM_ORG_DIM_UNIT_ID, 
     PD_DIM_ID, 
     SETL_CNL_DIM_ID, 
     TXN_CODE_DIM_ID, 
     TXN_CR_AMT_FCY, 
     TXN_CR_AMT_LCY, 
     TXN_DB_AMT_FCY, 
     TXN_DB_AMT_LCY, 
     TXN_TCKT_NBR, 
     SRC_STM_DIM_ID, 
     CNT_IND, 
     CR_X_DB_IND, 
     TXN_AMT_IND, 
     CARD_TP_ACQ_DIM_ID, 
     ACG_STC_ITM_DIM_ID, 
     PRIM_TXN_AMT_USD, 
     SCD_CCY_DIM_ID
)
select 
	 CST_TP_DIM_ID AS CST_TP_DIM_ID, 
     :pDate: AS CDR_DIM_ID, 
     CNL_DIM_ID AS CNL_DIM_ID, 
     CNL_TP_DIM_ID AS CNL_TP_DIM_ID, 
     CTY_OF_TXN_DIM_ID AS CTY_OF_TXN_DIM_ID, 
     CCY_DIM_ID AS CCY_DIM_ID, 
     CST_DIM_ID AS CST_DIM_ID, 
     PRIM_AR_DIM_ID AS PRIM_AR_DIM_ID, 
     PRIM_ORG_DIM_UNIT_ID AS PRIM_ORG_DIM_UNIT_ID, 
     PD_DIM_ID AS PD_DIM_ID, 
     SETL_CNL_DIM_ID AS SETL_CNL_DIM_ID, 
     TXN_CODE_DIM_ID AS TXN_CODE_DIM_ID, 
     SUM(TXN_CR_AMT_FCY) AS TXN_CR_AMT_FCY, 
     SUM(TXN_CR_AMT_LCY) AS TXN_CR_AMT_LCY, 
     SUM(TXN_DB_AMT_FCY) AS TXN_DB_AMT_FCY, 
     SUM(TXN_DB_AMT_LCY) AS TXN_DB_AMT_LCY, 
     COUNT(TXN_TCKT_NBR) AS TXN_TCKT_NBR, 
     a.SRC_STM_DIM_ID AS SRC_STM_DIM_ID, 
     CNT_IND AS CNT_IND, 
     CR_X_DB_IND AS CR_X_DB_IND, 
     TXN_AMT_IND AS TXN_AMT_IND, 
     CARD_TP_ACQ_DIM_ID AS CARD_TP_ACQ_DIM_ID, 
     ACG_STC_ITM_DIM_ID AS ACG_STC_ITM_DIM_ID, 
     SUM(NVL(PRIM_TXN_AMT_USD,0)) AS PRIM_TXN_AMT_USD, 
     NVL(SCD_CCY_DIM_ID,999999) AS SCD_CCY_DIM_ID
FROM dmmis..CNL_TXN_ANL_FCT A
left join dmmis..SRC_STM_DIM b on a.src_stm_dim_id= b.src_stm_dim_id

WHERE TO_DATE(A.CDR_DIM_ID,'YYYYDDD') >=DATE_TRUNC('MONTH',TO_DATE(:pDate:,'YYYYDDD'))
and TO_DATE(A.CDR_DIM_ID,'YYYYDDD') <=to_date(:pDate:,'yyyyddd')

and b.LVL_0_CODE not in ('TTSPKB_MT_OUT_BK'
,'TTSPKB_MT_IN_BK'
,'TTLTT_SALARY_HISTORY'
,'TTHDOL_TRANFER_HIST'
,'TTHDOL_BILL_HIST'
,'TTDP_MSGDAY_OUT'
,'THCH_PAYMENT_TRANS'
,'THCH_COLLECTION_TRANS'
,'TCC_CTU_HDR'
,'MB_TRANSACTION'
,'DFCORE_OD_TXN_MASTER'
,'BSMS_SMSOUT'
,'BSMS_SMSIN'
,'BIDVCORP_OD_TXN_MASTER'
)

GROUP BY 
 	CST_TP_DIM_ID , 
         CNL_DIM_ID, 
     CNL_TP_DIM_ID , 
     CTY_OF_TXN_DIM_ID , 
     CCY_DIM_ID, 
     CST_DIM_ID , 
     PRIM_AR_DIM_ID , 
     PRIM_ORG_DIM_UNIT_ID , 
     PD_DIM_ID , 
     SETL_CNL_DIM_ID , 
     TXN_CODE_DIM_ID , 
     a.SRC_STM_DIM_ID , 
     CNT_IND , 
     CR_X_DB_IND, 
     TXN_AMT_IND, 
     CARD_TP_ACQ_DIM_ID , 
     ACG_STC_ITM_DIM_ID , 
     NVL(SCD_CCY_DIM_ID,999999);

