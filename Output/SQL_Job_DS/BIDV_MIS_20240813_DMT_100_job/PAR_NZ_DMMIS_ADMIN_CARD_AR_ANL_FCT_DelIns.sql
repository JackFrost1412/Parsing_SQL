select 
	  twt.CDR_DIM_ID			CDR_DIM_ID
	, AR_DIM.AR_DIM_ID			AR_DIM_ID
	, NVL(PD_DIM.PD_DIM_ID,999999)		PD_DIM_ID
	, NVL(CST_DIM.CST_DIM_ID,999999)		CST_DIM_ID
	, NVL(TMP_CST_SEG.CST_OFCR_EMPE_DIM_ID,999999)		CST_RLTNP_OFCR_DIM_ID
	, NVL(TMP_CST_SEG.CST_MGT_DEPT_DIM_ID,999999)		CST_RLTNP_DEPT_DIM_ID
	, NVL(TMP_CST_SEG.CST_SEG_DIM_ID,999999)		CST_SEG_DIM_ID
	, NVL(AC_AR_DIM.AR_DIM_ID,999999)		AC_AR_DIM_ID
	, NVL(AR_LCS.AR_LIFE_CYC_ST_DIM_ID,999999)		AR_LIFE_CYC_ST_DIM_ID
	, NVL(AC_AR_LCS.AR_LIFE_CYC_ST_DIM_ID,999999)		AC_AR_LIFE_CYC_ST_DIM_ID
	, NVL(OU_DIM.ORG_UNIT_DIM_ID,999999)		ISSUING_ORG_UNIT_DIM_ID
	, twt.CARD_AR_ID			CARD_AR_ID
	, NVL(AR_OFCR_EMPE_DIM.EMPE_DIM_ID, 999999)		AR_OFCR_EMPE_DIM_ID   	, NVL(AR_DEP_MGT.ORG_UNIT_DIM_ID , 999999)		AR_MGT_DEPT_DIM_ID    	, NVL(TWT.AR_EFF_DT_ID, 999999)		AR_EFF_DT_DIM_ID  	, NVL(TWT.AR_LC_ST_DT_ID, 999999) 	AR_LC_ST_DT_DIM_ID 	, NVL(TWT.REV_SVC_LCY,0)			REV_SVC_LCY
	, NVL(TWT.BASE_PRIM_FTP_NET_CR_INCM_LCY,0)	BASE_PRIM_FTP_NET_CR_INCM_LCY
from TWT_CARD_AR_ANL_FCT TWT
inner join AR_DIM on AR_DIM.AR_ID = twt.AR_ID and AR_DIM.EFF_FM_DT <= to_date(:pDate:,'yyyyddd') and AR_DIM.EFF_TO_DT > to_date(:pDate:,'yyyyddd')
left join AR_DIM AC_AR_DIM on AC_AR_DIM.AR_ID = twt.AC_AR_ID and AC_AR_DIM.EFF_FM_DT <= to_date(:pDate:,'yyyyddd') and AC_AR_DIM.EFF_TO_DT > to_date(:pDate:,'yyyyddd')
left join CST_DIM on CST_DIM.CST_ID = twt.CST_ID and CST_DIM.EFF_FM_DT <= to_date(:pDate:,'yyyyddd') and CST_DIM.EFF_TO_DT > to_date(:pDate:,'yyyyddd')
left join PD_DIM on PD_DIM.PD_ID = twt.PD_ID and PD_DIM.EFF_FM_DT <= to_date(:pDate:,'yyyyddd') and PD_DIM.EFF_TO_DT > to_date(:pDate:,'yyyyddd')
left join AR_LC_ST_DIM AR_LCS on AR_LCS.LVL_0_ID = twt.AR_LIFE_CYC_ST_ID and AR_LCS.EFF_FM_DT <= to_date(:pDate:,'yyyyddd') and AR_LCS.EFF_TO_DT > to_date(:pDate:,'yyyyddd')
left join AR_LC_ST_DIM AC_AR_LCS on AC_AR_LCS.LVL_0_ID = twt.AC_AR_LIFE_CYC_ST_ID and AC_AR_LCS.EFF_FM_DT <= to_date(:pDate:,'yyyyddd') and AC_AR_LCS.EFF_TO_DT > to_date(:pDate:,'yyyyddd')
left join OU_DIM on OU_DIM.ORG_UNIT_ID = TWT.ISSUING_ORG_UNIT_ID and OU_DIM.EFF_FM_DT <= to_date(:pDate:,'yyyyddd') and OU_DIM.EFF_TO_DT > to_date(:pDate:,'yyyyddd')
left join TMP_CST_SEG on TMP_CST_SEG.CST_ID = twt.CST_ID
LEFT JOIN EMPE_DIM AR_OFCR_EMPE_DIM	ON AR_OFCR_EMPE_DIM.EMPE_ID = TWT.AR_OFCR_EMPE_ID AND TO_DATE(:pDate:,'YYYYDDD') >= AR_OFCR_EMPE_DIM.EFF_FM_DT AND AR_OFCR_EMPE_DIM.EFF_TO_DT >  TO_DATE(:pDate:,'YYYYDDD')
LEFT JOIN OU_DIM AR_DEP_MGT ON AR_DEP_MGT.ORG_UNIT_ID = TWT.AR_MGT_DEPT_ID AND TO_DATE(:pDate:,'YYYYDDD') >= AR_DEP_MGT.EFF_FM_DT AND AR_DEP_MGT.EFF_TO_DT >  TO_DATE(:pDate:,'YYYYDDD');

DELETE FROM CARD_AR_ANL_FCT WHERE CDR_DIM_ID = :pDate:;

INSERT INTO CARD_AR_ANL_FCT (CDR_DIM_ID
       , AR_DIM_ID
       , PD_DIM_ID
       , CST_DIM_ID
       , CST_RLTNP_OFCR_DIM_ID
       , CST_RLTNP_DEPT_DIM_ID
       , CST_SEG_DIM_ID
       , AC_AR_DIM_ID
       , AR_LIFE_CYC_ST_DIM_ID
       , AC_AR_LIFE_CYC_ST_DIM_ID
       , ISSUING_ORG_UNIT_DIM_ID
       , CARD_AR_ID
	   , AR_OFCR_EMPE_DIM_ID
	   , AR_MGT_DEPT_DIM_ID
	   , AR_EFF_DT_DIM_ID  	   , AR_LC_ST_DT_DIM_ID 	   , REV_SVC_LCY
	   , BASE_PRIM_FTP_NET_CR_INCM_LCY

)
SELECT CDR_DIM_ID
       , AR_DIM_ID
       , PD_DIM_ID
       , CST_DIM_ID
       , CST_RLTNP_OFCR_DIM_ID
       , CST_RLTNP_DEPT_DIM_ID
       , CST_SEG_DIM_ID
       , AC_AR_DIM_ID
       , AR_LIFE_CYC_ST_DIM_ID
       , AC_AR_LIFE_CYC_ST_DIM_ID
       , ISSUING_ORG_UNIT_DIM_ID
       , CARD_AR_ID
       , AR_OFCR_EMPE_DIM_ID
	   , AR_MGT_DEPT_DIM_ID
	   , AR_EFF_DT_DIM_ID  	   , AR_LC_ST_DT_DIM_ID 	   , REV_SVC_LCY
	   , BASE_PRIM_FTP_NET_CR_INCM_LCY
  FROM CARD_AR_ANL_FCT_DAILY;

