DELETE FROM  AST_AR_ANL_FCT_MONTHLY   WHERE TM_PRD_DIM_ID = :pDate:;

INSERT INTO AST_AR_ANL_FCT_MONTHLY
(
		 AR_ID
		,CR_RSK_RTG_DIM_ID
		,ACG_STC_GRP_DIM_ID
		,AR_OFCR_EMPE_DIM_ID
		,CST_SEG_DIM_ID 
		,CST_OFCR_EMPE_DIM_ID
		,AR_DIM_ID
		,AR_FNC_ST_DIM_ID
		,AR_LCS_DIM_ID
		,AR_PPS_DIM_ID
		,AR_TP_DIM_ID
		,BAL_ACG_STC_ITM_DIM_ID
		,CCY_DIM_ID
		,CST_DIM_ID
		,CST_PERF_ST_DIM_ID
		,CST_TP_DIM_ID
		,ORG_UNIT_DIM_ID
		,ORIG_TM_TO_MAT_SEG_DIM_ID
		,PD_DIM_ID
		,PDM_DIM_ID
		,SRC_STM_DIM_ID
		,TM_PRD_DIM_ID
		,AR_OFCR_CREATOR_DIM_ID
		,CST_OFCR_CREATOR_DIM_ID
		,AR_CRT_DEPT_DIM_ID
		,AR_MGT_DEPT_DIM_ID
		,CST_CRT_DEPT_DIM_ID
		,CST_MGT_DEPT_DIM_ID
		,CST_ID
		,CST_PERF_CARD_ST_DIM_ID
		,AST_ACR_PNY_INT_AMT_PTD_FCY
		,AST_ACR_PNY_INT_AMT_PTD_LCY
		,AST_ACR_INT_PTD_FCY
		,AST_ACR_INT_PTD_LCY
		,CLS_BAL_AMT_TDY_FCY
		,CLS_BAL_AMT_TDY_LCY
		,CLS_ON_BAL_AMT_TDY_FCY
		,CLS_ON_BAL_AMT_TDY_LCY
		,CLS_BG_BAL_AMT_TDY_FCY
		,CLS_BG_BAL_AMT_TDY_LCY
		,TOT_PAST_DUE_INT_AMT_FCY
		,TOT_PAST_DUE_INT_AMT_LCY
		,BILL_INT_AMT_FCY
		,BILL_INT_AMT_LCY
		,BILL_LATE_CHRG_AMT_FCY
		,BILL_LATE_CHRG_AMT_LCY
		,AGRT_BAL_AMT_MTD_LCY
		,AGRT_BAL_AMT_MTD_FCY
		,SUSP_ACR_INT_PTD_FCY
		,SUSP_ACR_INT_PTD_LCY
		        ,NBR_OF_DYS_HTD
        ,NBR_OF_DYS_MTD
        ,NBR_OF_DYS_QTD
        ,NBR_OF_DYS_YTD	 

)

WITH FCT  AS(
SELECT
		DF1.AR_ID
		,DF1.CR_RSK_RTG_DIM_ID
		,DF1.ACG_STC_GRP_DIM_ID
		,DF1.AR_OFCR_EMPE_DIM_ID
		,DF1.CST_SEG_DIM_ID 
		,DF1.CST_OFCR_EMPE_DIM_ID
		,DF1.AR_DIM_ID
		,DF1.AR_FNC_ST_DIM_ID
		,DF1.AR_LCS_DIM_ID
		,DF1.AR_PPS_DIM_ID
		,DF1.AR_TP_DIM_ID
		,DF1.BAL_ACG_STC_ITM_DIM_ID
		,DF1.CCY_DIM_ID
		,DF1.CST_DIM_ID
		,DF1.CST_PERF_ST_DIM_ID
		,DF1.CST_TP_DIM_ID
		,DF1.ORG_UNIT_DIM_ID
		,DF1.ORIG_TM_TO_MAT_SEG_DIM_ID
		,DF1.PD_DIM_ID
		,PDM_DIM.PDM_DIM_ID
		,DF1.SRC_STM_DIM_ID
	    ,:pDate:  TM_PRD_DIM_ID
		,DF1.AR_OFCR_CREATOR_DIM_ID
		,DF1.CST_OFCR_CREATOR_DIM_ID
		,DF1.AR_CRT_DEPT_DIM_ID
		,DF1.AR_MGT_DEPT_DIM_ID
		,DF1.CST_CRT_DEPT_DIM_ID
		,DF1.CST_MGT_DEPT_DIM_ID
		,DF1.CST_ID
		,DF1.CST_PERF_CARD_ST_DIM_ID
		,SUM(CLS_BAL_AMT_TDY_LCY)		AGRT_BAL_AMT_MTD_LCY
		,SUM(CLS_BAL_AMT_TDY_FCY)		AGRT_BAL_AMT_MTD_FCY
		,SUM(SUSP_ACR_INT_PTD_FCY)		SUSP_ACR_INT_PTD_FCY
		,SUM(SUSP_ACR_INT_PTD_LCY)		SUSP_ACR_INT_PTD_LCY

FROM AST_AR_ANL_FCT_DAY_FCY_1    DF1
INNER JOIN AST_AR_ANL_FCT_DAY_LCY_1   DL1  ON DF1.AR_ID =  DL1.AR_ID AND DF1.TM_PRD_DIM_ID = DL1.TM_PRD_DIM_ID
LEFT JOIN PD_DIM ON PD_DIM.PD_DIM_ID  = DF1.PD_DIM_ID 
LEFT JOIN PDM_DIM ON PD_DIM.PDM_DIM_ID = PDM_DIM.PDM_CODE
WHERE TO_DATE(DF1.TM_PRD_DIM_ID,'YYYYDDD') >= DATE_TRUNC('MONTH',TO_DATE(:pDate:,'YYYYDDD'))
AND  TO_DATE(DF1.TM_PRD_DIM_ID,'yyyyddd') <=to_date(:pDate:,'yyyyddd')
GROUP BY
		DF1.AR_ID
		,DF1.CR_RSK_RTG_DIM_ID
		,DF1.ACG_STC_GRP_DIM_ID
		,DF1.AR_OFCR_EMPE_DIM_ID
		,DF1.CST_SEG_DIM_ID 
		,DF1.CST_OFCR_EMPE_DIM_ID
		,DF1.AR_DIM_ID
		,DF1.AR_FNC_ST_DIM_ID
		,DF1.AR_LCS_DIM_ID
		,DF1.AR_PPS_DIM_ID
		,DF1.AR_TP_DIM_ID
		,DF1.BAL_ACG_STC_ITM_DIM_ID
		,DF1.CCY_DIM_ID
		,DF1.CST_DIM_ID
		,DF1.CST_PERF_ST_DIM_ID
		,DF1.CST_TP_DIM_ID
		,DF1.ORG_UNIT_DIM_ID
		,DF1.ORIG_TM_TO_MAT_SEG_DIM_ID
		,DF1.PD_DIM_ID
		,PD_DIM.PDM_DIM_ID
		,DF1.SRC_STM_DIM_ID
			,DF1.AR_OFCR_CREATOR_DIM_ID
		,DF1.CST_OFCR_CREATOR_DIM_ID
		,DF1.AR_CRT_DEPT_DIM_ID
		,DF1.AR_MGT_DEPT_DIM_ID
		,DF1.CST_CRT_DEPT_DIM_ID
		,DF1.CST_MGT_DEPT_DIM_ID
		,DF1.CST_ID
		,DF1.CST_PERF_CARD_ST_DIM_ID
		,PDM_DIM.PDM_DIM_ID
	)
SELECT   FCT.AR_ID
		,FCT.CR_RSK_RTG_DIM_ID
		,FCT.ACG_STC_GRP_DIM_ID
		,FCT.AR_OFCR_EMPE_DIM_ID
		,FCT.CST_SEG_DIM_ID 
		,FCT.CST_OFCR_EMPE_DIM_ID
		,FCT.AR_DIM_ID
		,FCT.AR_FNC_ST_DIM_ID
		,FCT.AR_LCS_DIM_ID
		,FCT.AR_PPS_DIM_ID
		,FCT.AR_TP_DIM_ID
		,FCT.BAL_ACG_STC_ITM_DIM_ID
		,FCT.CCY_DIM_ID
		,FCT.CST_DIM_ID
		,FCT.CST_PERF_ST_DIM_ID
		,FCT.CST_TP_DIM_ID
		,FCT.ORG_UNIT_DIM_ID
		,FCT.ORIG_TM_TO_MAT_SEG_DIM_ID
		,FCT.PD_DIM_ID
		,NVL(FCT.PDM_DIM_ID,999999)		PDM_DIM_ID
		,FCT.SRC_STM_DIM_ID
		,FCT.TM_PRD_DIM_ID
		,FCT.AR_OFCR_CREATOR_DIM_ID
		,FCT.CST_OFCR_CREATOR_DIM_ID
		,FCT.AR_CRT_DEPT_DIM_ID
		,FCT.AR_MGT_DEPT_DIM_ID
		,FCT.CST_CRT_DEPT_DIM_ID
		,FCT.CST_MGT_DEPT_DIM_ID
		,FCT.CST_ID
		,FCT.CST_PERF_CARD_ST_DIM_ID
		,NVL(DLYF1.AST_ACR_PNY_INT_AMT_PTD_FCY,0)   AST_ACR_PNY_INT_AMT_PTD_FCY
		,NVL(DLYL1.AST_ACR_PNY_INT_AMT_PTD_LCY,0)	AST_ACR_PNY_INT_AMT_PTD_LCY
		,NVL(DLYF1.AST_ACR_INT_PTD_FCY,0)			AST_ACR_INT_PTD_FCY
		,NVL(DLYL1.AST_ACR_INT_PTD_LCY,0)			AST_ACR_INT_PTD_LCY
		,NVL(DLYF1.CLS_BAL_AMT_TDY_FCY,0)			CLS_BAL_AMT_TDY_FCY
		,NVL(DLYL1.CLS_BAL_AMT_TDY_LCY,0)			CLS_BAL_AMT_TDY_LCY
		,NVL(DLYF1.CLS_ON_BAL_AMT_TDY_FCY,0)		CLS_ON_BAL_AMT_TDY_FCY
		,NVL(DLYL1.CLS_ON_BAL_AMT_TDY_LCY,0)		CLS_ON_BAL_AMT_TDY_LCY
		,NVL(DLYF1.CLS_BG_BAL_AMT_TDY_FCY,0)		CLS_BG_BAL_AMT_TDY_FCY
		,NVL(DLYL1.CLS_BG_BAL_AMT_TDY_LCY,0)		CLS_BG_BAL_AMT_TDY_LCY
		,NVL(DLYF1.TOT_PAST_DUE_INT_AMT_FCY,0)		TOT_PAST_DUE_INT_AMT_FCY
		,NVL(DLYL1.TOT_PAST_DUE_INT_AMT_LCY,0)		TOT_PAST_DUE_INT_AMT_LCY
		,NVL(DLYF1.BILL_INT_AMT_FCY,0)				BILL_INT_AMT_FCY
		,NVL(DLYL1.BILL_INT_AMT_LCY,0)				BILL_INT_AMT_LCY
		,NVL(DLYF1.BILL_LATE_CHRG_AMT_FCY,0)		BILL_LATE_CHRG_AMT_FCY
		,NVL(DLYL1.BILL_LATE_CHRG_AMT_LCY,0)		BILL_LATE_CHRG_AMT_LCY
		,FCT.AGRT_BAL_AMT_MTD_LCY
		,FCT.AGRT_BAL_AMT_MTD_FCY
		,FCT.SUSP_ACR_INT_PTD_FCY
		,FCT.SUSP_ACR_INT_PTD_LCY
		        , CAST((case when extract (month from TO_DATE(:pDate:,'YYYYDDD')) < 7 then (EXTRACT(DAY FROM TO_DATE(:pDate:,'YYYYDDD') - DATE_TRUNC('YEAR',TO_DATE(:pDate:,'YYYYDDD'))) + 1) else extract (day from TO_DATE(:pDate:,'YYYYDDD') - add_months(date_trunc('year',TO_DATE(:pDate:,'YYYYDDD')),6) ) + 1 end) AS SMALLINT) NBR_OF_DYS_HTD
        , CAST(TO_NUMBER(extract (day from TO_DATE(:pDate:,'YYYYDDD')),99)  AS SMALLINT) NBR_OF_DYS_MTD
        , CAST(TO_NUMBER(extract (day from TO_DATE(:pDate:,'YYYYDDD') - date_trunc('quarter', TO_DATE(:pDate:,'YYYYDDD'))),99) + 1  AS SMALLINT) NBR_OF_DYS_QTD
        , CAST(TO_NUMBER(extract (day from TO_DATE(:pDate:,'YYYYDDD') - date_trunc('YEAR', TO_DATE(:pDate:,'YYYYDDD'))),999) + 1   AS SMALLINT) NBR_OF_DYS_YTD	 
FROM FCT
LEFT JOIN AST_AR_ANL_FCT_DAY_FCY_1_DAILY  DLYF1
ON		FCT.AR_ID		=		DLYF1.AR_ID
	and	FCT.CR_RSK_RTG_DIM_ID 		= DLYF1.CR_RSK_RTG_DIM_ID
	and	FCT.ACG_STC_GRP_DIM_ID 		= DLYF1.ACG_STC_GRP_DIM_ID
	and	FCT.AR_OFCR_EMPE_DIM_ID 	= DLYF1.AR_OFCR_EMPE_DIM_ID
	and	FCT.CST_SEG_DIM_ID 			= DLYF1.CST_SEG_DIM_ID
	and	FCT.CST_OFCR_EMPE_DIM_ID	= DLYF1.CST_OFCR_EMPE_DIM_ID
	and	FCT.AR_DIM_ID				= DLYF1.AR_DIM_ID
	and	FCT.AR_FNC_ST_DIM_ID		= DLYF1.AR_FNC_ST_DIM_ID
	and	FCT.AR_LCS_DIM_ID			= DLYF1.AR_LCS_DIM_ID
	and	FCT.AR_PPS_DIM_ID			= DLYF1.AR_PPS_DIM_ID
	and	FCT.AR_TP_DIM_ID			= DLYF1.AR_TP_DIM_ID
	and	FCT.BAL_ACG_STC_ITM_DIM_ID	= DLYF1.BAL_ACG_STC_ITM_DIM_ID
	and	FCT.CCY_DIM_ID				= DLYF1.CCY_DIM_ID
	and	FCT.CST_DIM_ID				= DLYF1.CST_DIM_ID
	and	FCT.CST_PERF_ST_DIM_ID		= DLYF1.CST_PERF_ST_DIM_ID
	and	FCT.CST_TP_DIM_ID			= DLYF1.CST_TP_DIM_ID
	and	FCT.ORG_UNIT_DIM_ID			= DLYF1.ORG_UNIT_DIM_ID
	and	FCT.ORIG_TM_TO_MAT_SEG_DIM_ID	= DLYF1.ORIG_TM_TO_MAT_SEG_DIM_ID
	and	FCT.PD_DIM_ID				= DLYF1.PD_DIM_ID
		and	FCT.SRC_STM_DIM_ID			= DLYF1.SRC_STM_DIM_ID
	and	FCT.TM_PRD_DIM_ID			= DLYF1.TM_PRD_DIM_ID
	and	FCT.AR_OFCR_CREATOR_DIM_ID	= DLYF1.AR_OFCR_CREATOR_DIM_ID
	and	FCT.CST_OFCR_CREATOR_DIM_ID	= DLYF1.CST_OFCR_CREATOR_DIM_ID
	and	FCT.AR_CRT_DEPT_DIM_ID		= DLYF1.AR_CRT_DEPT_DIM_ID
	and	FCT.AR_MGT_DEPT_DIM_ID		= DLYF1.AR_MGT_DEPT_DIM_ID
	and	FCT.CST_CRT_DEPT_DIM_ID		= DLYF1.CST_CRT_DEPT_DIM_ID
	and	FCT.CST_MGT_DEPT_DIM_ID		= DLYF1.CST_MGT_DEPT_DIM_ID
	and	FCT.CST_ID					= DLYF1.CST_ID
	and	FCT.CST_PERF_CARD_ST_DIM_ID	= DLYF1.CST_PERF_CARD_ST_DIM_ID
	
LEFT JOIN AST_AR_ANL_FCT_DAY_LCY_1_DAILY  DLYL1 ON 
	FCT.AR_ID		=		DLYL1.AR_ID
	and	FCT.CR_RSK_RTG_DIM_ID 		= DLYL1.CR_RSK_RTG_DIM_ID
	and	FCT.ACG_STC_GRP_DIM_ID 		= DLYL1.ACG_STC_GRP_DIM_ID
	and	FCT.AR_OFCR_EMPE_DIM_ID 	= DLYL1.AR_OFCR_EMPE_DIM_ID
	and	FCT.CST_SEG_DIM_ID 			= DLYL1.CST_SEG_DIM_ID
	and	FCT.CST_OFCR_EMPE_DIM_ID	= DLYL1.CST_OFCR_EMPE_DIM_ID
	and	FCT.AR_DIM_ID				= DLYL1.AR_DIM_ID
	and	FCT.AR_FNC_ST_DIM_ID		= DLYL1.AR_FNC_ST_DIM_ID
	and	FCT.AR_LCS_DIM_ID			= DLYL1.AR_LCS_DIM_ID
	and	FCT.AR_PPS_DIM_ID			= DLYL1.AR_PPS_DIM_ID
	and	FCT.AR_TP_DIM_ID			= DLYL1.AR_TP_DIM_ID
	and	FCT.BAL_ACG_STC_ITM_DIM_ID	= DLYL1.BAL_ACG_STC_ITM_DIM_ID
	and	FCT.CCY_DIM_ID				= DLYL1.CCY_DIM_ID
	and	FCT.CST_DIM_ID				= DLYL1.CST_DIM_ID
	and	FCT.CST_PERF_ST_DIM_ID		= DLYL1.CST_PERF_ST_DIM_ID
	and	FCT.CST_TP_DIM_ID			= DLYL1.CST_TP_DIM_ID
	and	FCT.ORG_UNIT_DIM_ID			= DLYL1.ORG_UNIT_DIM_ID
	and	FCT.ORIG_TM_TO_MAT_SEG_DIM_ID	= DLYL1.ORIG_TM_TO_MAT_SEG_DIM_ID
	and	FCT.PD_DIM_ID				= DLYL1.PD_DIM_ID
		and	FCT.SRC_STM_DIM_ID			= DLYL1.SRC_STM_DIM_ID
	and	FCT.TM_PRD_DIM_ID			= DLYL1.TM_PRD_DIM_ID
	and	FCT.AR_OFCR_CREATOR_DIM_ID	= DLYL1.AR_OFCR_CREATOR_DIM_ID
	and	FCT.CST_OFCR_CREATOR_DIM_ID	= DLYL1.CST_OFCR_CREATOR_DIM_ID
	and	FCT.AR_CRT_DEPT_DIM_ID		= DLYL1.AR_CRT_DEPT_DIM_ID
	and	FCT.AR_MGT_DEPT_DIM_ID		= DLYL1.AR_MGT_DEPT_DIM_ID
	and	FCT.CST_CRT_DEPT_DIM_ID		= DLYL1.CST_CRT_DEPT_DIM_ID
	and	FCT.CST_MGT_DEPT_DIM_ID		= DLYL1.CST_MGT_DEPT_DIM_ID
	and	FCT.CST_ID					= DLYL1.CST_ID
	and	FCT.CST_PERF_CARD_ST_DIM_ID	= DLYL1.CST_PERF_CARD_ST_DIM_ID;

