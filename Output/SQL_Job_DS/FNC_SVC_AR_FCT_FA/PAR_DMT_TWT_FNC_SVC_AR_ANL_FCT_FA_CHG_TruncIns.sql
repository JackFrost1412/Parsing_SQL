SELECT
	AC_AR.AC_AR_ID
	,PD_AR.PD_ID
	,COALESCE(LN.LAST_EFF_DT, OD.LAST_EFF_DT, CARD.LAST_EFF_DT)							LAST_EFF_DT
	,COALESCE(LN.ADJ_BAL, OD.ADJ_BAL, CARD.ADJ_BAL)										ADJ_BAL
	,AR.UNQ_ID_IN_SRC_STM																AR_UNQ_ID
	,CASE WHEN
		CASE WHEN LN.AR_ID IS NOT NULL THEN 'LN'
			WHEN OD.AR_ID IS NOT NULL THEN 'OD'
			WHEN CARD.AR_ID IS NOT NULL THEN 'CARD'
		END IN ('OD', 'CARD') THEN PD_AR.PRM_CST_ID
	ELSE NULL END																		CST_ID
	,CASE WHEN LN.AR_ID IS NOT NULL THEN 'LN'
		WHEN OD.AR_ID IS NOT NULL THEN 'OD'
		WHEN CARD.AR_ID IS NOT NULL THEN 'CARD'
	END																					MUD
	,PD.UNQ_ID_IN_SRC_STM																PD_CODE
	,CCY.CCY_CODE																		CCY_CODE
	,CARD.CARD_ID
	,CARD_AR.SALE_EMPE_ID
	,COALESCE(LN.ACG_STC_ITM_ID, OD.ACG_STC_ITM_ID, AU.ACG_STC_ITM_ID)					ACG_STC_ITM_ID
	,NVL(MAP.MA_NHOM_NO, 'NORM') 														CARD_AR_FNC_ST_TP_CODE
	,RPRG_OU.UNQ_ID_IN_SRC_STM															RPRG_OU_CODE
	,LN.LN_FNC_ST_CODE
FROM AC_AR
LEFT JOIN TWT_CUST_LOAN_FA LN ON AC_AR.AC_AR_ID = LN.AR_ID
LEFT JOIN TWT_CST_OD_OPEN OD	ON AC_AR.AC_AR_ID = OD.AR_ID
LEFT JOIN TWT_CARD_OPEN CARD	ON AC_AR.AC_AR_ID = CARD.AR_ID
LEFT JOIN AR           			ON AC_AR.AC_AR_ID = AR.AR_ID
LEFT JOIN IP RPRG_OU			ON RPRG_OU.IP_ID = AR.RPRG_OU_ID
LEFT JOIN PD_AR         		ON AC_AR.AC_AR_ID = PD_AR.PD_AR_ID
LEFT JOIN PD 					ON PD.PD_ID = PD_AR.PD_ID
LEFT JOIN CCY 					ON CCY.CCY_ID = AR.DNMN_CCY_ID
LEFT JOIN AR CARD_AR			ON CARD_AR.AR_ID = CARD.CARD_ID
LEFT JOIN TMP_AR_X_AU AU		ON AU.AR_ID = CARD.AR_ID AND AU.AR_X_AU_TP_CODE = 'AR_X_DR_AU'
LEFT JOIN CC_AR_SMY SMY			ON CARD.AR_ID = SMY.CC_AR_ID 	AND smy.MSR_PRD_ID = :pdate:
LEFT JOIN EXT_XLS_MAP_NHOMNO_THE_TDY MAP ON SMY.NOD_PAST_DUE < NVL(MAP.HIGH_VAL, SMY.NOD_PAST_DUE + 1)
	AND SMY.NOD_PAST_DUE >= NVL(MAP.LOW_VAL, SMY.NOD_PAST_DUE)
	AND SMY.NOD_PAST_DUE >= NVL(MAP.LOW_VAL, SMY.NOD_PAST_DUE)
WHERE AC_AR.SRC_STM_ID IN ('3FBF9A0B41B2BE2CA30C68E2B64D00A7','85425375A0630AA9C05A16D7D3420345','D461039F96DF94CBDFD7BC02909C9521')
AND COALESCE(LN.AR_ID,OD.AR_ID,CARD.AR_ID) IS NOT NULL;

