select
chg.AC_AR_ID
,decode(CHG.MUD, 'OD', ABS(CLS_VAL_BAL_FCY*CHG.ADJ_BAL), CLS_VAL_BAL_FCY*CHG.ADJ_BAL)	CLS_BAL_FCY   
,decode(CHG.MUD, 'OD', ABS(CLS_VAL_BAL_LCY*CHG.ADJ_BAL), CLS_VAL_BAL_LCY*CHG.ADJ_BAL)	CLS_BAL_LCY
,TVR.LQD_AMT_FCY                               			LQD_AMT_FCY
,TVR.LQD_AMT_LCY                       	    			LQD_AMT_LCY
,TVR.DSBR_AMT_TDY_FCY                                   DSBR_AMT_FCY
,TVR.DSBR_AMT_TDY                                      	DSBR_AMT_LCY
,TVR.PREPYMT_AMT	                                    PREPYMT_AMT_FCY
,TVR.PREPYMT_AMT*TVR.EXG_RATE_TO_LCL_CCY	            PREPYMT_AMT_LCY
,TVR.PY_OFF_BFR_DUE_DT_F                              	PY_OFF_BFR_DUE_DT_F
,decode(tvr.CLS_VAL_BAL_FCY*CHG.ADJ_BAL , 0, 'NORM', 
		COALESCE(CAST(CHG.LN_FNC_ST_CODE AS VARCHAR2(100)), ARF.CL_CODE, CAST(CHG.CARD_AR_FNC_ST_TP_CODE AS VARCHAR2(100))))	    ADJ_FNC_ST_CODE ,CASE WHEN decode(tvr.CLS_VAL_BAL_FCY*CHG.ADJ_BAL , 0, 'NORM', 
		COALESCE(CAST(CHG.LN_FNC_ST_CODE AS VARCHAR2(100)), ARF.CL_CODE, CAST(CHG.CARD_AR_FNC_ST_TP_CODE AS VARCHAR2(100)))) <> 'NORM' AND PNP_ARS + INT_ARS > 0 THEN 'THUC_TE' 
      WHEN decode(tvr.CLS_VAL_BAL_FCY*CHG.ADJ_BAL , 0, 'NORM', 
		COALESCE(CAST(CHG.LN_FNC_ST_CODE AS VARCHAR2(100)), ARF.CL_CODE, CAST(CHG.CARD_AR_FNC_ST_TP_CODE AS VARCHAR2(100)))) <> 'NORM' AND PNP_ARS + INT_ARS = 0 THEN 'THU_THACH'
 END                                        			FNC_ST_TP_CODE
,DLQ.PNP_ARS
,DLQ.INT_ARS
,DLQ.NOD_PAST_DUE
,TVR.DSBR_AMT_LTD TOT_DSBR_AMT_FCY
,TVR.INTERIM_INT
,CASE WHEN DLQ.PNP_PAST_DUE_DT <= nvl(DLQ.INT_PAST_DUE_DT,99991231) AND PAST_DUE_F = 1
	  AND  DLQ.PNP_PAST_DUE_DT IS NOT NULL 
	  THEN MONTHS_BETWEEN(Trunc(to_date(:pdate:,'yyyymmdd'),'MONTH'),Trunc(to_date(DLQ.PNP_PAST_DUE_DT,'yyyymmdd'),'MONTH')) 
	  WHEN PAST_DUE_F = 1 AND DLQ.INT_PAST_DUE_DT <= nvl(DLQ.PNP_PAST_DUE_DT,99991231) 
	  AND  DLQ.INT_PAST_DUE_DT IS NOT NULL 
	  THEN MONTHS_BETWEEN(Trunc(to_date(:pdate:,'yyyymmdd'),'MONTH'),Trunc(to_date(DLQ.INT_PAST_DUE_DT,'yyyymmdd'),'MONTH'))
	  ELSE 0 END DLQ_CNT
,decode(CHG.MUD, 'OD', ABS(CLS_VAL_BAL_FCY), CLS_VAL_BAL_FCY) ORIG_CLS_BAL_FCY
,decode(CHG.MUD, 'OD', ABS(CLS_VAL_BAL_LCY), CLS_VAL_BAL_LCY) ORIG_CLS_BAL_LCY
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG chg
LEFT JOIN AR_DLQ_SMY DLQ ON ac_AR_ID = DLQ.AR_ID AND DLQ.MSR_PRD_ID = :pdate:
LEFT JOIN TWT_AR_TVR_SMY_DAILY TVR ON ac_AR_ID = TVR.AR_ID AND TVR.MSR_PRD_ID = :pdate:
LEFT JOIN (SELECT ARF.AR_ID, ARF.EFF_DT, ARF.END_DT, CD.CL_CODE
	FROM AR_FNC_ST ARF
	LEFT JOIN CV CD ON CD.CL_ID = ARF.AR_FNC_ST_TP_ID
      WHERE ARF.AR_FNC_ST_SCM_ID = 'FF2F2563FA9BFED792EDC3A35EFDEE92') ARF ON AC_AR_ID = ARF.AR_ID 
	  AND ARF.EFF_DT <= LAST_EFF_DT AND ARF.END_DT > LAST_EFF_DT --LU_CV: 'AR_FNC_ST_SCM', 'USR_DFND_ST';

SELECT AC_AR.AC_AR_ID
	,nvl(max(decode(AR_AVY.CL_CODE, 'PRINCIPAL', DUE_AMT)), 0) PNP_DUE_AMT 	,nvl(max(decode(AR_AVY.CL_CODE, 'MAIN_INT', DUE_AMT)), 0) INT_DUE_AMT FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG AC_AR
LEFT JOIN (
	SELECT AR_AVY.*
		,CV.CL_CODE
	FROM AR_AVY
	JOIN CV ON AR_AVY.AVY_TP_ID = CV.CL_ID
		AND CV.CL_SCM_CODE = 'AVY_TP'
		AND AR_AVY.SRC_STM_ID = '92D4125CCD5B1BDF51F47FBCCDBBBF27' 		AND CV.CL_CODE IN (
			'PRINCIPAL'
			,'MAIN_INT'
			)
	) AR_AVY ON AC_AR.AC_AR_ID = AR_AVY.AR_ID
LEFT JOIN (
	SELECT AVY_SHD.AR_AVY_ID
		,SUM(nvl(AVY_SHD.SHD_AMT, 0) - nvl(AVY_SHD.ACT_AMT, 0)) DUE_AMT 	FROM AR_AVY_SHD_ITM AVY_SHD
	WHERE AVY_SHD.EFF_DT <= :pdate:
		AND AVY_SHD.END_DT > :pdate:
		AND AVY_SHD.EXPC_END_DT <= :pdate:
		AND AVY_SHD.SHD_AMT > AVY_SHD.ACT_AMT
	GROUP BY AVY_SHD.AR_AVY_ID
	) AVY_SHD ON AR_AVY.AR_AVY_ID = AVY_SHD.AR_AVY_ID
GROUP BY AC_AR.AC_AR_ID;

SELECT LOAN.AC_AR_ID, SUM(TOT_AVL_LMT_AMT) TOT_AVL_LMT_AMT
FROM (SELECT AC_AR.AC_AR_ID
	,nvl(RI_VAL.CLT_VALT - RI_VAL.LMT_CTB, 0) TOT_AVL_LMT_AMT
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG AC_AR
LEFT JOIN AR_X_RI_RLTNP AR_X_RI ON AR_X_RI.AR_ID = AC_AR.AC_AR_ID
	AND AR_X_RI.EFF_DT <= AC_AR.LAST_EFF_DT
	AND AR_X_RI.END_DT > AC_AR.LAST_EFF_DT
	AND AR_X_RI.AR_X_RI_RLTNP_TP_ID = 'B6C71A2D532689A626795C8D4B67A75D' 	AND AR_X_RI.SRC_STM_ID = '0A173E8726B6D97003B5EE634C0CCA92' LEFT JOIN RI ON AR_X_RI.RI_ID = RI.RI_ID and RI.SRC_STM_ID = 'BB35A878C33FFBF19ADA056E5449DAAF' LEFT JOIN (
	SELECT RI_VAL.RI_ID
		,NVL(MAX(DECODE(CL_CODE, 'CLT_VALT', RI_VAL.VAL_AMT)), 0) CLT_VALT
		,NVL(MAX(DECODE(CL_CODE, 'LMT_CTB', RI_VAL.VAL_AMT)), 0) LMT_CTB
	FROM RI_VAL
	JOIN CV ON RI_VAL.RI_VAL_TP_ID = CV.CL_ID
		AND CV.CL_SCM_CODE = 'RI_VAL_TP'
		AND CV.CL_CODE IN (
			'CLT_VALT'
			,'LMT_CTB'
			)
	WHERE RI_VAL.EFF_DT <= :pdate:
		AND RI_VAL.END_DT > :pdate:
	GROUP BY RI_VAL.RI_ID
	) RI_VAL ON RI_VAL.RI_ID = RI.RI_ID
LEFT JOIN RI_X_UDF_RLTNP RI_X_UDF ON RI_X_UDF.RI_ID = RI.RI_ID
	AND RI_X_UDF.EFF_DT <= :pdate:
	AND RI_X_UDF.END_DT > :pdate:
LEFT JOIN (
	SELECT RI_X_CL.*
		,CV.CL_NM
	FROM RI_X_CL_RLTNP RI_X_CL
	JOIN CV ON RI_X_CL.CL_ID = CV.CL_ID
		AND RI_X_CL.EFF_DT <= :pdate:
		AND RI_X_CL.END_DT > :pdate:
	WHERE RI_X_CL.RI_X_CL_RLTNP_TP_ID = '1AD160750012C416E42B551CC5CA4A5F' 	) COLL_CGY ON COLL_CGY.RI_ID = RI.RI_ID
LEFT JOIN AR_LC_ST LC_ST ON LC_ST.AR_ID = AR_X_RI.AR_ID
	AND LC_ST.SRC_STM_ID = '85425375A0630AA9C05A16D7D3420345' 	AND LC_ST.AR_LC_ST_SCM_ID = '6B7D2ED561F31655BADF9F232E792DE2' 	AND LC_ST.EFF_DT <= AC_AR.LAST_EFF_DT
	AND LC_ST.END_DT > AC_AR.LAST_EFF_DT
WHERE RI_X_UDF.UDF_ID = '890E57353540716EA2E539E6A39DBB33' 	AND RI_X_UDF.UDF_VAL <> 'KHAC'
	AND RI_LC_ST_TP_ID = '4C32D5E60A5794603A48F0E1AC950315' 	AND LC_ST.AR_LC_ST_TP_ID IN (
		'7D108472968DF6F6A56D5BDFC01488A9'
		,'06CD0B184A47E6CEB56653555A20950F'
		) 	AND COLL_CGY.CL_NM IN (
		'121101'
		,'121102'
		,'121103'
		,'121991'
		,'121992'
		,'121993'
		,'122101'
		,'122102'
		,'122201'
		,'122202'
		,'122203'
		,'123101'
		,'123102'
		,'123201'
		,'123202'
		,'123301'
		,'123302'
		,'124001'
		,'124002'
		,'124003'
		,'125001'
		,'125002'
		,'125003'
		,'126001'
		,'126002'
		,'126003'
		,'129991'
		,'129992'
		,'129993'
		,'170301'
		,'170302'
		)) LOAN
GROUP BY LOAN.AC_AR_ID

UNION ALL

SELECT AC_AR.AC_AR_ID
	,nvl(CASE 
			WHEN AR_X_LMT.LMT_AMT > 0
				THEN (
						CASE 
							WHEN NVL(TVR_SMY.CLS_VAL_BAL_LCY, 0) < 0
								THEN AR_X_LMT.LMT_AMT + NVL(TVR_SMY.CLS_VAL_BAL_LCY, 0)
							ELSE AR_X_LMT.LMT_AMT
							END
						)
			ELSE C.TOT_AVL_LMT_AMT
			END, 0) TOT_AVL_LMT_AMT
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG AC_AR
LEFT JOIN AR_X_LMT_TP_RLTNP AR_X_LMT ON AC_AR.AC_AR_ID = AR_X_LMT.AR_ID
LEFT JOIN AR_TVR_SMY TVR_SMY ON AC_AR.AC_AR_ID = TVR_SMY.AR_ID
	AND TVR_SMY.MSR_PRD_ID = :pdate:
LEFT JOIN (
	SELECT AR_X_AR.SBJ_AR_ID AR_ID
		,CR_USG_SMY.CLS_AVL_AMT TOT_AVL_LMT_AMT
	FROM AR_X_AR_RLTNP AR_X_AR
	LEFT JOIN AR_CR_USG_SMY CR_USG_SMY ON AR_X_AR.OBJ_AR_ID = CR_USG_SMY.AR_ID
	WHERE AR_X_AR.SRC_STM_ID = 'A859AEF31E787D7AAA50F314F87DE330'
		AND CR_USG_SMY.MSR_PRD_ID = :pdate:
		AND AR_X_AR.EFF_DT <= :pdate:
		AND AR_X_AR.END_DT > :pdate:
		AND AR_X_AR.AR_X_AR_RLTNP_TP_ID = 'E9BCF51A07832895CE3CAFED32695B4D'
	) C ON AC_AR.AC_AR_ID = C.AR_ID
WHERE AC_AR.MUD = 'OD'
	AND AR_X_LMT.EFF_DT <= AC_AR.LAST_EFF_DT
	AND AR_X_LMT.END_DT > AC_AR.LAST_EFF_DT
	AND AR_X_LMT.LMT_TP_ID = 'B00397055F38C5365C64B45D8CD5DFE3';

SELECT AC_AR_ID, SUM(LMT_AMT) LMT_AMT
FROM (
SELECT AC_AR.AC_AR_ID
	,nvl(AR_X_AR.LMT_AMT, 0) LMT_AMT
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG AC_AR
JOIN AR_X_AR_RLTNP AR_X_AR ON AC_AR.AC_AR_ID = AR_X_AR.SBJ_AR_ID
	AND AR_X_AR.EFF_DT <= :pdate:
	AND AR_X_AR.END_DT > :pdate:
	AND AR_X_AR.SRC_STM_ID = '0A173E8726B6D97003B5EE634C0CCA92' 	AND AR_X_AR.AR_X_AR_RLTNP_TP_ID IN ('48AD3C9EF52018E228A295F9A93E5DF4', 'F3B20F07E2D8DDE866BED28D24F7FCE4') WHERE AC_AR.MUD = 'LN'
UNION ALL
SELECT AC_AR.AC_AR_ID
	,nvl(AR_X_RI.LMT_AMT, 0) LMT_AMT
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG AC_AR
JOIN (
	SELECT AR_X_RI.AR_ID
		,AR_X_RI.EFF_DT
		,AR_X_RI.END_DT
		,AR_X_RI.LMT_AMT
	FROM AR_X_RI_RLTNP AR_X_RI
	WHERE AR_X_RI.EFF_DT <= :pdate:
		AND AR_X_RI.END_DT > :pdate:
		AND AR_X_RI.SRC_STM_ID = '0A173E8726B6D97003B5EE634C0CCA92'
	) AR_X_RI ON AR_X_RI.AR_ID = AC_AR.AC_AR_ID
WHERE AC_AR.MUD = 'LN'
	AND AR_X_RI.EFF_DT <= :pdate:
	AND AR_X_RI.END_DT > :pdate:
) GROUP BY AC_AR_ID
UNION ALL
SELECT A.AC_AR_ID
	,NVL(LMT.LMT_AMT, 0) LMT_AMT
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG A
LEFT JOIN AR_X_LMT_TP_RLTNP LMT ON A.AC_AR_ID = LMT.AR_ID
	AND LMT.EFF_DT <= :pdate:
	AND LMT.END_DT > :pdate:
	AND LMT.LMT_TP_ID = 'B00397055F38C5365C64B45D8CD5DFE3' WHERE A.MUD = 'OD';

SELECT AC_AR_ID, SUM(CLS_UTLZ_AMT_FCY) CLS_UTLZ_AMT_FCY
FROM (
SELECT AC_AR.AC_AR_ID , nvl(AR_X_AR.LINKED_AMT_FCY ,0) CLS_UTLZ_AMT_FCY 
			FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG AC_AR 
			LEFT JOIN (SELECT AR_X_AR.SBJ_AR_ID, AR_X_AR.EFF_DT, AR_X_AR.END_DT, AR_X_AR.LINKED_AMT_FCY 
			FROM AR_X_AR_RLTNP AR_X_AR JOIN CV ON AR_X_AR.SRC_STM_ID = CV.CL_ID 
                 AND CV.CL_SCM_CODE = 'SRC_STM' 
                 AND CL_CODE = 'FCC.CLTB_ACC_COLL_LINK_DTLS'
                 WHERE AR_X_AR.EFF_DT <= :pdate: AND AR_X_AR.END_DT > :pdate:) AR_X_AR 
                 ON AC_AR.AC_AR_ID = AR_X_AR.SBJ_AR_ID  
where AC_AR.MUD = 'LN'     
AND AR_X_AR.EFF_DT <= AC_AR.LAST_EFF_DT AND AR_X_AR.END_DT > AC_AR.LAST_EFF_DT
UNION
SELECT AC_AR.AC_AR_ID , nvl(AR_X_RI.RI_AMT ,0) CLS_UTLZ_AMT_FCY 
			FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG AC_AR 
			LEFT JOIN (SELECT AR_X_RI.AR_ID, AR_X_RI.EFF_DT, AR_X_RI.END_DT, AR_X_RI.RI_AMT 
			FROM AR_X_RI_RLTNP AR_X_RI
                 WHERE AR_X_RI.SRC_STM_ID = '0A173E8726B6D97003B5EE634C0CCA92'
                 AND AR_X_RI.EFF_DT <= :pdate: AND AR_X_RI.END_DT > :pdate:) AR_X_RI 
                 ON AC_AR.AC_AR_ID = AR_X_RI.AR_ID  
where AC_AR.MUD = 'LN'     
AND AR_X_RI.EFF_DT <= AC_AR.LAST_EFF_DT AND AR_X_RI.END_DT > AC_AR.LAST_EFF_DT)
GROUP BY AC_AR_ID;

SELECT CHG.AC_AR_ID, 
PST_ENTR.PST_ENTR_AMT_LCY FEE_INCM_LCY
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG CHG
LEFT JOIN PST_ENTR  ON PST_ENTR.REL_AR_ID = CHG.AC_AR_ID
AND PST_DT = :pdate:
LEFT JOIN AR_X_AU_RLTNP AR_X_AU ON CHG.AC_AR_ID = AR_X_AU.AR_ID 
AND AR_X_AU.SRC_STM_ID = '85425375A0630AA9C05A16D7D3420345' AND AR_X_AU.EFF_DT <= :pdate: AND AR_X_AU.END_DT > :pdate:
LEFT JOIN AU ON AU.AU_ID = AR_X_AU.AU_ID 
WHERE CHG.PD_CODE IN ('C11M', 'C11S', 'M9P1', 'M9PM', 'M9PS', 'N9PS')
AND AU.ACG_STC_ITM_ID IN (select function_hash02('GL' || '|' || 'FCC.GLTM_GLMASTER', FIELD1) 
from EXT_FCC_jrtb_parameters a where a.srv_id = 'GL023CB')
AND ACG_TP_ID = '6BD323629A5B4A768A50D4F091BB2952' -- CUST_GL = 'G';

select
	chg.ac_ar_id,
	axr.EFF_RATE_PCT	INT_RATE
from TWT_FNC_SVC_AR_ANL_FCT_FA_CHG chg
left join ar_x_rate_tp_rltnp AXR on AXR.ar_x_rate_tp_rltnp_tp_id ='B1D1E14709EF08BBB38D361A980E4DE1'
    AND AXR.RATE_TP_ID = '2EC90B394FDFF95D4EC063F17BE70B47' 
    AND AXR.RATE_CMPT = 'INTEREST_RATE'
	and AXR.ar_id = chg.AC_AR_ID AND AXR.EFF_DT <= LAST_EFF_DT AND AXR.END_DT > LAST_EFF_DT;

SELECT 
 CHG.AC_AR_ID                                               AC_AR_ID
,decode(CHG.MUD, 'LN', XIP.IP_ID, CHG.CST_ID)           CST_ID
,CASE WHEN CHG.MUD IN ('OD', 'CARD') THEN '139900'
    WHEN CHG.MUD = 'LN' THEN UDF.UDF_VAL
    ELSE NULL END                                       LOAN_PPS_CODE
,CHG.PD_CODE                                            PD_CODE
,NVL(SALE.IP_ID, CHG.SALE_EMPE_ID)                      RLTNP_OFCR_ID
,IDY.UDF_VAL                                            IDY_CODE
,CHG.ACG_STC_ITM_ID                                     LDGR_ACG_ID
,NVL(XOU.IP_CODE, CHG.RPRG_OU_CODE)                     ADJ_OU_CODE
,CHG.CCY_CODE                                           ADJ_CCY_CODE
,CG.CL_ID                                               CG_SEG
,MSEG.CL_ID                                             MSEG
,EMPE.EMPE_NBR
,CHG.AR_UNQ_ID
,CASE WHEN CHG.MUD IN ('LN', 'OD') THEN 'FCC' ELSE 'SMV' END    PD_SRC_STM_CODE
,CHG.CARD_ID                                            PYMT_CARD_ID
,CHG.MUD
,CHG.RPRG_OU_CODE
FROM TWT_FNC_SVC_AR_ANL_FCT_FA_CHG CHG
LEFT JOIN TMP_AR_X_CST XIP   ON XIP.AR_ID = AC_AR_ID AND XIP.EFF_DT <= LAST_EFF_DT AND XIP.END_DT > LAST_EFF_DT LEFT JOIN TMP_AR_X_SALE_PERSON SALE ON SALE.AR_ID = AC_AR_ID AND SALE.EFF_DT <= LAST_EFF_DT AND SALE.END_DT > LAST_EFF_DT  LEFT JOIN TMP_AR_X_OU XOU ON XOU.AR_ID = AC_AR_ID AND XOU.EFF_DT <= LAST_EFF_DT AND XOU.END_DT > LAST_EFF_DT  LEFT JOIN (SELECT UDF.*, CV.CL_CODE FROM AR_X_UDF_RLTNP UDF
            INNER JOIN CV ON UDF.UDF_VAL_ID = CV.CL_ID AND CV.CL_CODE LIKE 'MUC DICH VAY.%'
            INNER JOIN CV SRC ON SRC.CL_ID = UDF.SRC_STM_ID AND SRC.CL_CODE ='FCC.CLTB_ACCOUNT_APPS_MASTER'
            ) UDF ON UDF.AR_ID = AC_AR_ID AND UDF.EFF_DT <= LAST_EFF_DT AND UDF.END_DT > LAST_EFF_DT
LEFT JOIN (SELECT IDY.* FROM IP_X_UDF_RLTNP IDY
            left join cv on cv.cl_id = idy.UDF_VAL_ID
            WHERE IDY.UDF_ID = '13CDBEEEE9199559A9EF8794322E43E7'
            AND CV.CL_CODE IS NOT NULL) IDY ON IDY.IP_ID = decode(CHG.MUD, 'LN', XIP.IP_ID, CHG.CST_ID) AND IDY.EFF_DT <= LAST_EFF_DT AND IDY.END_DT > LAST_EFF_DT
LEFT JOIN TMP_CL_X_IP_INDUSTRY_TP CG ON decode(CHG.MUD, 'LN', XIP.IP_ID, CHG.CST_ID) = CG.IP_ID AND CG.EFF_DT <= LAST_EFF_DT AND CG.END_DT > LAST_EFF_DT  LEFT JOIN TMP_CL_X_IP_MSEG MSEG ON decode(CHG.MUD, 'LN', XIP.IP_ID, CHG.CST_ID) = MSEG.IP_ID AND MSEG.EFF_DT <= LAST_EFF_DT AND MSEG.END_DT > LAST_EFF_DT  LEFT JOIN EMPE ON SALE.IP_ID = EMPE.EMPE_ID;

